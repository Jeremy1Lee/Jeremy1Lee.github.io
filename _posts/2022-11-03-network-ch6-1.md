---
layout: post
title: "计网 Ch6：应用层-1"
author: LJC
tags:
- network
date: 2022-11-03 15:40 +0800
toc: true
---

# 应用层 (Application layer) - Part1

## 1. 应用层概述

应用层享受其下各层提供的服务，解决通过应用进程的交互来**实现特定网络应用的问题**。

应用层作为最顶层，是**设计和建立计算机网络的最终目的**，也是计网中发展最快的部分。
- 早期基于文本的应用（电子邮件，远程登陆，文件传输，新闻）；
- 万维网 www；
- 即时通信，P2P 文件共享，音视频应用；
- 新型网络应用；

接下来以一些经典的网络应用为例，来学习有关**网络应用**的原理，协议和实现方面的知识。

- ![app01.png](/images/net/app01.png "经典的网络应用")

--------------

## 2. 客户-服务器(C/S) 方式 和 对等(P2P) 方式

网络应用程序运行在处于网络边缘的不同端系统上，通过彼此间的通信来共同完成某项任务。

因此开发一种网络应用，首先要考虑的问题是**网络应用程序在各种端系统上的组织方式 和 它们之间的关系**。目前流行的主要有以下两种：
- **客户-服务器** (Clien t/ Server) 方式
- **对等** (Peer-to-Peer) 方式

### 客户-服务器

客户 和 服务器 是指通信中所涉及的**两个应用进程**。这种方式描述的是进程之间的 **服务和被服务的关系**。它是因特网上传统的，最成熟的方式，很多应用都是这种方式，如www，电子邮件等。

- 如图，首先明确一下概念：
    - 主机 A 运行客户程序，正在运行的客户程序称为客户进程/ 客户
        - 运行客户进程的主机称为客户计算机，有时也可简称为客户（区分）；
    - 主机 B 运行服务器程序，正在运行的服务器程序称为服务器进程/ 服务器，
        -  运行服务器进程的主机称为服务器计算机，有时也可简称为服务器；
    - ![app02.png](/images/net/app02.png "客户 和 服务器")

<br/>

- 在 客户-服务器 方式下，客户向服务器请求服务，服务器收到请求后向客户提供服务；
    - 客户是服务请求方
    - 服务器是服务提供方
    - **服务器总是处于运行状态**，并等待客户的服务请求。**服务器具有固定运输层端口号**（如HTTP服务器的默认端口号80），而**运行服务器的主机也具有固定的 IP 地址。**

- 基于C/S方式的应用服务通常是**服务集中型**的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上。
    - 不过，由于一台服务器给多个客户机提供服务，实际应用中**常会出现服务器跟不上众多客户机请求的情况**；
    - 为此，在C/S应用中常用**计算机群集**（服务器场）构建一个强大的**虚拟服务器**。

###  对等方式

对等方式 **没有固定的服务请求者和服务提供者**，各应用进程是对等的，称为**对等方**，它们**相互直接通信**，每个对等方既是服务请求者，又是服务提供者。

- 例如某种网络下载工具软件P2P下载器，如图，E 的 P2P进程正在从 F 下载文件，同时还为D的P2P进程提供下载服务。
    - ![app03.png](/images/net/app03.png "对等方式")

- 基于 P2P 的应用是**服务分散型**的，因为应用服务不是集中在少数几个服务器计算机，而是分散在大量对等计算机中，这些计算机不为ISP所有，而是为个人控制的台式机/笔记本，常位于住宅，校园，办公室等。
- P2P 方式最突出之一是它的**可拓展性**。系统每增加一个对等方，不仅增加了请求者，还增加了服务提供者，**系统性能不会因规模增大而降低**。
- P2P 具有**成本**上的优势，因为它不需要服务器和带宽。

--------------------

## 3. 动态主机配置协议 DHCP

DHCP 是 TCP/IP 协议体系中应用层的协议，它使用运输层的 **UDP** 提供的服务

### DHCP 的作用：自动给各主机配置信息

看如下场景：如何配置用户主机才能使 用户主机正常访问Web服务器？
- ![dhcp01.png](/images/net/dhcp01.png "DHCP场景")

正确配置 IP 地址，子网掩码，默认网关，DNS 服务器等网络相关配置信息。我们可以手工配置，如图：但是网络中主机较多，就不能一个一个配了，而且容易出错！
- ![dhcp02.png](/images/net/dhcp02.png "DHCP场景")

如果给网络中添加一台 **DHCP 服务器**，并在该服务器中设置好 网络中其他各主机的网络配置信息 怎么配，其他主机开机后，自动启动DHCP程序，向DHCP服务器请求自己的网络配置信息，这样网络中各主机都可以从 DHCP 服务器**自动获取**网络配置信息，而不用一个一个手工配置了。
- ![dhcp03.png](/images/net/dhcp03.png "DHCP场景")

### DHCP 的六大工作流程

假设网络中有两台 DHCP 服务器和多台用户主机，下面以一台主机为例：
![dhcp04.png](/images/net/dhcp04.png "DHCP工作场景")

- DHCP 使用客户-服务器方式：
    -  DHCP 服务器上运行 DHCP 服务器进程，可简称为 DHCP 服务器；
    -  用户主机上运行 DHCP 客户进程，可简称为 DHCP 客户；

- 由于用的是 UDP 协议， DHCP 报文在运输层被封装成 UDP 用户数据报，在网络层封装成 IP 数据报，再根据所用的**网络接口**封装成数据链路层的帧进行发送（例如以太网帧），后面不再赘述逐层封装的过程，其中：
    - DHCP **服务器**使用的 UDP 端口是 **67**；
    - DHCP **客户**使用的 UDP 端口是 **68**；都是熟知端口；

**下面看看 DHCP 客户与 DHCP 服务器的交互过程：**

**（一）DHCP 发现报文 (DHCP DISCOVER)**

启用主机的 DHCP 后，DHCP 客户将**广播发送 DHCP 发现报文 (DISCOVER)**：

- IP 数据报中：
    - 其源 IP 地址为0.0.0.0（因为主机当前还未分配到 IP 地址，用 0 代替）
    - 目的 IP 地址为 255.255.255.255 （广播）
- 之所以**广播**，是因为主机现在并不知道网络中有哪几个 DHCP 服务器，以及它们的 IP 地址。
- ![dhcp05.png](/images/net/dhcp05.png "DHCP工作场景")

<br/>

广播域中的所有设备都会收到该 IP 数据报（应用层是DHCP 发现报文），并对其层层解封，解封出封装有 DHCP 发现报文的 UDP 用户数据报。该 UDP 用户数据报目的端口是 67（DHCP 服务器进程）。
- DHCP 客户 的应用层没有 监听端口 67 的进程，UDP 无法交付，丢弃；
- DHCP 服务器 的应用层运行着 DHCP 服务器进程，接收 DHCP 发现报文并作出响应；
    -  DHCP 发现报文细节不讨论，只知其封装了 **事物ID** 和 **DHCP客户端的 MAC 地址**；
- ![dhcp06.png](/images/net/dhcp06.png "DHCP工作场景")

<br/>

**（二）DHCP 提供报文 (DHCP OFFER)**

**服务器** 收到DHCP发现报文后，根据其中封装的 DHCP客户端的 MAC 地址 来查找自己的**数据库**，看是否有针对该 MAC 地址的配置信息；
- 如果有，使用**相应的配置信息** 构建并发送 **DHCP 提供报文 (OFFER)**；
- 如果没有，采用**默认配置信息** 构建并发送 DHCP 提供报文；
- **DHCP 提供报文 (OFFER)**的源 IP 地址为服务器地址，目的地址仍然是**广播地址**；
    - 这是因为客户机目前还没有配置 IP 地址，只能广播发回客户；
- ![dhcp07.png](/images/net/dhcp07.png "DHCP工作场景")

<br/>

广播域中的所有设备都会收到 DHCP **提供**报文的 IP 数据报，并对其层层解封，解封出封装有 DHCP 提供报文的 UDP 用户数据报。服务器广播的提供报文的目的端口是 68 （DHCP 客户进程端口号）：
- DHCP 服务器 的应用层没有 监听端口 68 的进程，UDP 无法交付，丢弃；
- DHCP 客户 的应用层运行着 DHCP 客户进程，接收该 DHCP 提供报文，并作出响应；
- DHCP 客户根据 DHCP 提供报文中的**事务 ID** 来判断该报文是否 **是自己所请求的**报文；
    - 如果该事务 ID 与自己之前发送的 DHCP 发现报文中的 事务 ID 相等，表明这就是自己刚向服务器请求的报文，可以接受，否则丢弃。
        - 提供报文 中，还封装有 配置信息（IP地址，子网掩码，地址租期，默认网关，DNS服务器等）
        - 其中对于 IP 地址，DHCP 服务器在地址池中 给客户挑选给主机租用哪个 IP 地址时，会**使用 ARP 确保所选 IP 地址未被网络中其他主机占用**；
- ![dhcp08.png](/images/net/dhcp08.png "DHCP工作场景")

<br/>

**（三）DHCP 请求报文 (DHCP REQUEST)**

对于本例，两个 DHCP 都会广播给主机它们挑选的 IP 地址，客户验证事务 ID发现是给自己的，并从中选择一个（一般选择先到的那个），然后客户向所选择的 DHCP 服务器发送 **DHCP 请求报文(DHCP REQUEST)**。
- 封装 请求报文 的 IP 数据报的源 IP 地址仍为 0.0.0.0 ，因为此时客户才从多个 DHCP 服务器中挑选一个作为自己的 DHCP 服务器。客户首先需要征得服务器的同意，才能正式使用服务器给它租用的 IP 地址，所以还用着 0.0.0.0 ；
- 目的 IP 地址仍为广播地址，无需向每一个服务器单独发送 DHCP 请求报文来通知是否请求它们作为自己的 DHCP 服务器；
- DHCP 请求报文中封装有 事务 ID，DHCP 客户的 MAC地址，接受租约中的 IP 地址，提供此租约的服务器端的 IP 地址等信息。
- ![dhcp09.png](/images/net/dhcp09.png "DHCP工作场景")

<br/>

**（四）DHCP 确认报文 (DHCP ACK)**

对于本例，假设选择 服务器1 作为自己的 DHCP 服务器，而且服务器1 接受了该请求，那么服务器1 给 客户发送 **DHCP 确认报文 (ACK)**：
- 封装 确认报文 的 IP 数据报的源 IP 地址为 DHCP 服务器1 的 IP地址；
- 目的 IP 地址仍为广播地址；
- ![dhcp10.png](/images/net/dhcp10.png "DHCP工作场景")

<br/>

**（五）DHCP 谢绝报文 (DHCP DECLINE)**

DHCP 客户收到该确认报文后，就可以使用所租用到的地址了。使用之前还要注意：主机还会使用 ARP 协议检测该IP 地址是否已被其他主机占用：
- 如果被占用：客户给 DHCP 服务器发送 **DHCP 谢绝报文 (DECLINE)**，来谢绝 IP 地址租约，并**重新广播** DHCP 发现报文；
- 未被占用：则可以使用租约中的 IP 地址与其他主机通信；

**（六）租用期过半后**

当租用期过半时，客户向服务器发送 **DHCP 请求报文 (DHCP REQUEST)**，来更新租用期。
- 封装 该报文 的 IP 数据报的源 IP 地址为 客户之前租用到的 IP 地址；
- 目的 IP 地址为 DHCP 服务器1 的地址；
- ![dhcp11.png](/images/net/dhcp11.png "DHCP工作场景")

DHCP 服务器的反应：
- 若同意，则发回 **DHCP 确认报文 (DHCP ACK)**，这样客户就得到了新的租用期；
    - ![dhcp12.png](/images/net/dhcp12.png "情况1")
- 若不同意，则发回 **DHCP 否认报文 (DHCP NACK)**，客户必须立即停止使用之前租用的 IP 地址，并重新发送 DHCP 发现报文重新申请 IP 地址；
    - ![dhcp13.png](/images/net/dhcp13.png "情况2")
- 若 DHCP 服务器**未作出响应**，则在 租用期过了 87.5% 时，客户必须重新发送DHCP 请求报文 (DHCP REQUEST)，然后继续等待 服务器可能的反应：
    - 若**响应**了，按上面的同意/ 不同意处理；
    - 若还是**未响应**，则 租用期到期后，客户必须立即停止使用之前租用的 IP 地址，并重新发送 DHCP 发现报文重新申请 IP 地址；
    - 【注意】客户可以随时提前终止 DHCP 服务器所提供的租用期，这时只需要向 DHCP 服务器发送 **DHCP 释放报文 (DHCP RELEASE)** 段即可；
    - ![dhcp14.png](/images/net/dhcp14.png "DHCP工作场景")

综上所述，整个过程分为：
- DHCP 客户 寻找服务器
- 服务器提供 IP 地址租用
- 客户接受 IP 地址租约
- 服务器确认 IP 地址租约
- IP 地址续约
- 客户随时解除 IP 地址租约
- ![dhcp15.png](/images/net/dhcp15.png "DHCP工作全过程")

其中**两次用到了 ARP 协议**，一次是服务器在地址池中挑选 IP 地址时用 ARP 挑选别人没用过的 IP ，另一次是客户正式租用地址之前也会使用 ARP 来检测该 IP 是否被其他主机占用。

### DHCP 中继代理：由于路由器隔离广播域

如图，黄色区域的两个主机不能自动获取到 IP 地址等网络配置信息，因为路由器隔离了广播域。
- ![dhcp16.png](/images/net/dhcp16.png "DHCP中继代理的场景")

解决方法是给路由器配置 DHCP 服务器的 IP地址，并使其成为 DHCP 中继代理。

由于配置了路由，收到广播转发给另一个广播域的DHCP服务器；
- ![dhcp17.png](/images/net/dhcp17.png "DHCP中继代理")

使用中继代理（如路由器）的原因是：我们并不会给每个网络都设置一个 DHCP 服务器，这样DHCP 服务器就太多了。

------------------------

## 4. 域名系统 DNS (Domain  Name System)

### DNS 的作用

主机要访问某台 web 服务器，只需要在主机中运行某个**浏览器**软件，在其地址栏中输入要访问的web服务器的**域名**，即可访问到 web 服务器提供的内容。
- ![dns01.png](/images/net/dns01.png "DNS")

再看这个，ping [北航的域名](https://www.buaa.edu.cn/)，但能看到实际上 ping 的是该 web 服务器的IP地址：
- ![dns02.png](/images/net/dns02.png "DNS")

这也再次对应了 TCP/IP 是使用 IP 地址进行寻址的，即：不用域名，只用IP地址也可以通过IP地址来寻址目的主机，但显然是域名更好记。因此一般使用域名，而不是IP地址来访问目的主机。

对于本例，当在浏览器中输入某个web服务器的域名时，主机首先在自己的DNS高速缓存中查找该域名对应的 IP 地址。如果没找到，则向网络中的某台 DNS 服务器查询，**DNS 服务器中有域名和IP地址映射关系的数据库**。
- ![dns03.png](/images/net/dns03.png "DNS的作用")

DNS 服务器收到 DNS 查询报文后，在其数据库中查询，然后将查询结果（域名对应的 IP地址）发给用户主机，现在主机就可以通过web服务器的IP地址，对其访问了。

> 那么因特网是否可以只用一台 DNS 服务器呢？

理论可行，但实际不可取。因特网规模很大，这么大的域名服务器肯定因为负荷而无法工作，一旦域名服务器出现故障，整个因特网就会瘫痪。因特网早在 1983 就用层次结构的命名树作为主机名（域名），并使用分布式的域名系统 DNS。**DNS使大多数域名都在本地解析，仅少量解析需要在因特网上通信，因此效率很高**。而且由于是分布式系统，即使单个 DNS 服务器出现故障，也不会妨碍整个系统正常运行。
<br/>

### 因特网的域名结构

因特网采用**层次树状结构的域名结构**：
- 域名结构由若干分量组成，各分量之间用 点【**.**】 隔开，分别代表不同级别的域名；
    - 不同级别的域名：
    - ![dns04.png](/images/net/dns04.png "域名")
    - 每一级的域名都由英文字母和数字组成，不超过 63 个字符，**不区分大小写字母**；
    - 级别最低的域名在最左，级别最高的顶级域名在最右；
    - 完整的域名不超过255个字符；
- 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级域名代表什么意思；

- 各级域名由其上一级的域名管理机构管理，最高的顶级域名由 ICANN 管理。
    - ![dns05.png](/images/net/dns05.png "北航邮箱域名")

<br/>

**顶级域名 TLD** (Top Level Domain) 分为以下三类：
- 顶级域名 ：
    - **国家**顶级域名 nTLD ：如 cn 表示中国，us 表示美国等；
    - **通用**顶级域名 gTLD ：常用七个：com（公司企业），net（网络服务机构），org（非营利性组织），int（国际组织），edu（美国教育机构），gov（美国政府部门），mil（美国军事部门）；
    - 反向域 arpa ：用于反向域名解析，即 IP 地址反向解析为域名；
- 在国家顶级域名下注册的二级域名均有该国家自行确定。例如顶级域名为 jp 的日本，将其教育和企业机构的二级域名定为 ac 和 co，而不用 edu 和 com；
- **我国 二级域名**划分为以下两类：
    - 类别域名 共七个：ac（科研机构）、com（工、商、金融等企业）、edu（教育机构）、gov（政府部门）、net（提供网络服务的机构）、mil（军事机构）、org（非营利性组织）。
    - 行政区域名 34个：用于各省，直辖市，如 bj 为北京市，sh 为上海市等；
    - 【注意】顶级域名com和我国企业域名com，名称相同等级不同；

因特网的域名空间：
- ![dns06.png](/images/net/dns06.png "因特网的域名空间")

**这种按等级管理的命名方法便于维护名字的唯一性，也容易设计出一种高效的域名查询机制。但域名只是个逻辑概念，并不代表计算机的物理地点。**

域名 和 IP 地址的映射关系必须保存在域名服务器中，以供所有其他应用查询。不能都存在一个服务器中，DNS 使用 **分布在各地的域名服务器** 来实现 域名到 IP 地址的转换。

域名服务器可划分为以下四种不同类型：
- **根域名服务器**：最高层次的域名服务器，每个根域服务器都知道所有的顶级域名服务器的域名及其 IP 地址。因特网共有 13 个不同 IP 地址的根域名服务器（实际以服务器群集的形式）；
    - 本地域名服务器向根域名服务器发出查询请求时，路由器就把查询请求报文 转发到离这个 DNS 客户最近的一个根域名服务器，这样加快了DNS查询过程，合理利用资源。
    - **根域名服务器通过不直接对域名解析，而是返回该域名所属顶级域名的顶级域名服务器的 IP 地址**；
- **顶级域名服务器**：复杂**管理在该顶级域名服务器注册的所有二级域名**。收到 DNS 查询请求时就给出相应的回答（可能是最终结果，也可能是下一级 权限域名服务器 的 IP 地址，视URL）
- **权限域名服务器**：管理某个区的域名。每个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管辖的域名与 IP 地址的映射关系。
    - 另外，权限域名服务器还知道其 下级域名服务器的地址；
- **本地域名服务器**：不属于上述域名服务器的等级结构。当一个主机发出 DNS 请求报文时，这个报文首先被送往该主机的本地域名服务器。
    - **本地域名服务器起代理的作用，会将该报文转发到上述的域名服务器的等级结构中**。
    - 每个 ISP ，大学等都可以有一个本地域名服务器，有时也称**默认域名服务器**。
    - 本地域名服务器 离用户较近，一般不超过几个路由器的距离，甚至在一个局域网中；
    - 本地域名服务器 的 IP 地址需要直接配置在需要域名解析的主机中；

---------------

### 域名解析（递归 / 迭代） ，高速缓存

如图，左为递归查询，右为迭代查询：
- ![dns07.png](/images/net/dns07.png "递归查询")
- 递归查询：查询结果会在 之前受委托的各域名服务器 之间传递，最终传回给用户主机：
- 迭代查询，一次查到一个服务器，再向新服务器查询，显然这种方式对被查询的域名服务器负担太大，通常采用图中的模式：从请求主机到本地域名服务器的查询是递归查询，而其余的查询是迭代查询；
- DNS 报文使用 **UDP** 协议封装，运输层**端口号为 53**。

**高速缓存**：避免迭代/递归查询，在本地留有记录：

- 为了提高  DNS 查询效率，并减轻根域名服务器的负荷和减少因特网上的 DNS 查询报文数量，在域名服务器中广泛地使用了**高速缓存**。高速缓存用来存放最近查询过的域名，以及从何处获得域名映射信息的记录；
- ![dns08.png](/images/net/dns08.png "迭代查询")

- 不过，域名到 IP 地址的映射关系并不是永久不变的，为保持高速缓存中的内容正确，域名服务器**应为每项内容设置计时器**，并删除超时项（比如 两天）；
- 本地域名服务器需要高速缓存，用户主机也很需要高速缓存。许多用户主机在启动时从本地域名服务器下载域名和 IP 地址的全部数据库，**维护**存放自己最近使用的域名的**高速缓存**，并且只 在缓存里找不到域名时 才向服务器查询。主机也要保持高速缓存的正确性。

最后举个例子，对于 [buaa.edu.cn](https://www.buaa.edu.cn/) ，一个本地 DNS 服务器可能查询0次（高速缓存里有），也可能查询4次（根 → cn → edu → buaa）。

----------------

### 5. 文件传输协议 FTP








