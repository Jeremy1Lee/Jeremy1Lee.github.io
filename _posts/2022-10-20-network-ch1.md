---
layout: post
title: "计网 Ch1：体系架构"
author: LJC
tags:
- network
date: 2022-10-20 15:10 +0800
toc: true
---

# 一、计算机网络概述

## 1. 网络，互连（联）网，因特网

**网络（Network）**由**结点（Node）**和连接它们的**链路（Link）**组成。

![net01.png](/images/net/net01.png "网络和互联网"){: .align-center}

小网络由**路由器**互联，形成范围更大的网络，即网络的网络。最终，互联网是最大的网络。小写的 internet 是一个通用名词，泛指多个计算机网络互联而成的网络，这些网络之间的通信协议可以是任意的，而因特网 Internet 是一个专用名词，采用 **TCP/IP** 协议族作为通信的规则。

ISP（Internet Service Provider）：网络服务提供商，普通用户通过 ISP 提供的 IP 地址接入互联网。我国的ISP：电信，移动，联通。如图，一旦某个用户能够接入到互联网，他也可以成为一个ISP，购置 调制解调器和路由器 ，让其他用户和他相连。因此很容易添加新的分支。ISP的网络结构如下：

![net02.png](/images/net/net02.png "ISP的网络结构"){: .align-center}

路由器在网络中起核心作用，它是一种专用计算机，但不是主机 (host) ，是实现分组交换的关键构造，任务是转发收到的**分组**。

----------

## 2. 【重要】三种交换方式：电路交换，分组交换，报文交换

电话机，如果全世界的电话都两两相连，需要无穷的电话线。我们直接搞一种分接设备，在里面让线拐弯不就行了？让需要通信的任意两部电话线路按需接通。如果电话进一步增加，就相应增加电话交换机的数量，来完成交换任务，构成电信网。

![cir01.png](/images/net/cir01.png "从电话线讲起"){: .align-center}

![cir02.png](/images/net/cir02.png "电话线"){: .align-center}

从通信资源分配的角度看，交换（Switching）就是按某种方式动态分配传输线路的资源。

1. **电路（Circuit）交换**：电路交换可以实现计算机数据传输，但效率很低，因为计算机数据是突发的，每次都得等分配，所以计算机网络常采用分组交换。**分三步：建立连接，通话，释放连接。**

![cir03.png](/images/net/cir03.png "电路交换"){: .align-center}

2. **分组（Packet）交换**：什么是分组？如下图：将报文进行处理，加入控制信息得到分组。

![packet.png](/images/net/packet.png "分组"){: .align-center}

- **路由器是最重要的分组交换机**，（如图）将各种网络互连的同时，并对接收到的分组进行转发，也就是进行分组交换。如图，得到报文先分组，然后添加首部。

![cir04.png](/images/net/cir04.png "分组交换"){: .align-center}

- **报文：表示消息的整块数据称为一个报文**。

为什么要不惜额外数据量添加**报头**？显然这种网络结构不像两两直连那样明确发给谁，所以报头里一定要包含**各分组目的地址**的信息，便于分组转发（真就是字面意思，**分组+存储转发**）。看图，分组交换机（路由器）收到分组后，先暂时将分组存储，再检查其首部，按目的地址进行查表转发，找到合适的转发接口，通过接口将分组转发给下一个分组交换机。总结就是：

- 消息发送方：构造分组，发送分组；
- 路由器（分组交换机）：缓存分组，转发分组；
- 消息接收方：接收分组，还原报文；

3）报文（Message）交换：对报文大小没有限制（不分组），现在较少使用。

![sum01.png](/images/net/sum01.png "总结"){: .align-center}

总结：图中看出，分组交换比报文交换减少了时延（报文交换需要缓存时间，分组交换利用缓存的时间，边缓存边转发，利用率更高）。

电路交换的优点：
- 1）通信时延小，因为线路是双方专用的，且直达。当连续传大量数据时很明显。
- 2）有序传输，只走这一条路，不会失序（由于网络结构，不同分组则会走不同路，可能失序）；
- 3）没有冲突；

但是缺点：
- 1）建立连接时间长
- 2）使用效率低
- 3）灵活性差，坏了一个就不好用了
- 4）难以规格化，难以差错控制

分组交换优点：
- 1）无需建立连接
- 2）线路利用率高
- 3）简化存储管理，因为分组长度固定
- 4）后一个分组的存储和前一个的转发同步进行
- 5）减少重发数据量，可靠性和时延++

但是缺点：
- 1）有转发时延，但已经比报文交换小了
- 2）额外信息量（源地址，目的地址等控制信息）
- 3）可能出现失序，丢失，重复分组问题

----------

## 3. 计算机网络的定义和分类

- 最简单的定义：**互连**的，**自治计算机**的集合。互连：有线/无线；自治：独立，可以单独运行；集合：至少要两台计算机。
- 定义：计算机网络由一些通用的，可编程的硬件**互联**而成，并非专门用来实现某一目的，可传送多种不同类型数据。

按交换技术分类：电路交换，分组交换和报文交换；

按覆盖范围分类：
- <mark>广域网 WAN</mark> ：几十到几千公里，互连城域网和局域网
- <mark>城域网 MAN</mark> ：5-50公里，覆盖城市，互连企业，机构，校园局域网
- <mark>局域网 LAN</mark> ：1 公里左右，楼，实验室
- <mark>个域网 PAN</mark> ：10 米，不连接普通计算机，而是个人电子设备

按拓扑结构分类：
- 总线型网络：用一根传输线把计算机连起来，建网容易，增减方便，节省线路，但一处故障全网瘫痪。
- 星型网络：中间一般是交换机和路由器，便于管理，但中间对故障敏感。
- 环形网络：环中信号单向传输。
- 网状型网络：每个结点至少由两条路径与其他结点相连，多用于广域网，可靠性高但复杂

----------

## 4. 计算机网络的性能指标

首先明确单位：
- <mark>**8 bit （比特） = 1 Byte （字节）**</mark>

- 1 KB = 1024(2^10) Byte ；
- 1 MB = 1024(2^10) KB ；

8 个常用指标：

###  1）**速率 Data rate**

连接在计算机网络上的主机在数字信道上传送比特的速率，也称比特率(bit rate) 或数据率。单位bit/s, bps, kb/s = 10^3 b/s

![bit01.png](/images/net/bit01.png "bit"){: .align-center}

### 2）**带宽 Bandwidth**
带宽在信号处理和计算机网络中的定义不同：

1. 在**模拟信号**中：信号所包含的各种不同频率成分所占据的**频率范围**（如频谱图中的山峰），单位 Hz 。

2. 在**计算机网络**中：网络的**通信线路传送数据的能力**。网络带宽表示单位时间内网络中一点到另一点能通过的**最高数据率**，单位 **b/s** , kb/s 。作为数据传输的上限，直接关系到网络应用体验。（可以想象成水管的粗细，流速一定，越粗的传输量越大）

### 3）**吞吐量 Throughput**
**单位时间内通过某个网络（或信道，接口）的数据量**。即实际网络中有多少数据量通过，受带宽和额定速率的限制，大多数情况下，吞吐量都小于带宽。

### 4）**时延 Delay**

分组从 源主机 送到 目的主机 的全过程，有以下三种时延：

1. 源主机 (一个一个地) 将分组发往传输线路 —— **发送时延**

2. 代表分组的电信号在链路上传输花费的时间 —— **传播时延**

3. 路由器收到分组后存储转发 —— 处理（排队）时延

由于路线上有多个路由器和多段线路，这些时延将不止一次出现，路由器受网络动态变化，软硬件性能不同影响不好计算处理（排队）时延。关于时延的计算如图：关于两种时延哪个在主导并不能确定，看公式，这取决于分组长度和距离。（发送速率取小者）【注意】无论分组长度怎么变，传播时延只有一个（也就是只走一次），发送时延可能和分组数有关。

![delay01.png](/images/net/delay01.png "时延"){: .align-center}

### 5) **时延带宽积 Bandwidth-Delay Product**
<mark>时延带宽积 = **传播时延(s) × 带宽(bit/s)**</mark>。从公式来看，它表示如果连续发送数据，表示第一个 bit 到达目的地时已经发送了多少 bit 。链路的时延带宽积又称为**以比特为单位的链路长度**，即原来的长度是物理意义上的，我走100km才到，时延带宽积是我发送这么多，才有 bit 陆续到达目的地。

### 6）**往返时间 Round-Trip Time**
因特网上的信息不只有单方向传输，而是双向交互。从源主机发送分组开始，直到源主机收到来自目的主机的确认分组为止，如下图从以太网 host 到 LAN 的往返时间。

![rtt.png](/images/net/rtt.png "RTT"){: .align-center}

### 7）**利用率**
利用率分为信道利用率和网络利用率。

1. **信道利用率** 表示某信道有百分之几的时间是被利用（有数据通过）的。

2. **网络利用率** 表示全网络信道利用率的加权平均。

![usage.png](/images/net/usage.png "RTT"){: .align-center}

根据排队论，某信道利用率增大，该信道引起的时延也会迅速增加（原因如上图），因此道利用率并非越大越好。一般控制不超过50%，如果超过了就要增大线路带宽。也不能太低，会浪费。应该使用一些机制动态调整网络通信量，使利用率保持合理。

### 8）**丢包率/分组丢失率  Packet loss**

指一定时间范围内，**传输过程中丢失的分组数量与总分组数**之比。具体可分为接口丢包率，结点丢包率，链路丢包率，路径丢包率，网络丢包率等。运维人员非常关心，但普通用户并不能意识到。**分组丢失**主要有两种情况：
1. 分组在传输过程中出现误码，被结点交换机检测出并丢弃；

2. 网络拥塞，即分组到达一台队列已满的分组交换机时被丢弃，通信量较大时就可能造成网络拥塞。比如某路由器的缓存区已满（或达到拥塞控制的阈值），再有分组到达该路由器就只能丢弃。

因此，丢包率反映了**网络的拥塞情况**，无拥塞时丢包率为 0 ，轻为 1%-4% ，重为 5%-15% ，丢包较高则网络应用无法正常工作。

----------
## 5. 计算机网络体系结构（抽象概念较多）

计算机网络及其构件应完成功能的建模和定义。

### 1）常见的计算机网络体系结构：七层，四层，五层

为了使不同体系结构的网络都能互连，体系结构必不可少。OSI 复杂并且运行效率较低，层次划分也不太合理，一些功能多次出现。TCP/IP 在网络层使用的协议是 IP 协议，即网际协议，因此 TCP/IP 的网络层称为**网际层**。

![protocol.png](/images/net/protocol.png "protocol"){: .align-center}

计算机的操作系统中都带有 TCP/IP 协议族（四层）。路由器也有 TCP/IP 协议族，不过它只有两层，如图。整个 TCP/IP 体系中有大量的协议， IP 协议和 TCP 是最重要的两个，因此用它们两个表示。 TCP/IP 协议族也可以叫协议栈，因为和栈的画法一致， TCP/IP 协议通信的过程其实就对应着**数据入栈与出栈**的过程。入栈的过程，数据发送方每层**不断地封装首部与尾部**，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地**拆除首部与尾部**，得到最终传输的数据。

![protocol02.png](/images/net/protocol02.png "进栈与出栈"){: .align-center}

1. **网络接口层**没有规定用什么网络接口等具体内容，这是为了便于各种接口互连，如有线的以太网接口，无限局域网的WiFi接口。因此，本质上只有三层。

2. **网际层**的核心是 IP 协议，可以将不同网络接口进行互连，并向其上的 TCP 和 UDP 提供网络互连服务。 **IP 协议一方面互连网络接口，另一方面为各种网络应用提供服务**。

3. TCP 和 UDP 是**运输层**的两个重要协议。 

    - **TCP** 在享受 IP 协议提供的网络互连服务基础上，向应用层的相应协议提供**可靠传输**的服务。 
    - **UDP** 在享受 IP 协议提供的网络互连服务基础上，向应用层的相应协议提供**不可靠传输**的服务

4. **应用层**包含了大量应用协议，既然是应用，那么都是面向不同使用场景的，比如浏览网页的 HTTP 协议，发邮件的 SMTP 协议等。部分协议基于 TCP ，部分基于 UDP ，并且都有各自的运输层端口号。

![tcpip.png](/images/net/tcpip.png "TCP/IP Protocol"){: .align-center}

注意图片右侧，IP 协议在其中体现了承上启下的作用，Everything Over IP 。然而网络接口层什么都没写，不利于理解究竟是怎么接入的，接下来，为了便于学习理解网络原理，折中综合成五层的**原理体系结构**，如图：

![five.png](/images/net/five.png "五层网络"){: .align-center}

----------
### 2）计算机网络体系结构分层的必要性

计算机网络是非常复杂的系统，分层可以将复杂问题分解为局部问题。那么分层究竟是为了解决哪些问题而提出的？为什么要提出分层？

> 现在只考虑这个问题：我们如何让两台主机之间通信？

![nes01.png](/images/net/nes01.png "物理层"){: .align-center}

1. 对于两台计算机，物理意义上的互连可以由网线， RJ45 网线接口，和表示01的方波信号 来实现。

> 这就是**物理层**要解决的问题，现在我们可以在两台主机之间传输信号了！

![nes02.png](/images/net/nes02.png "数据链路层"){: .align-center}

2. 但是对于总线网络，所有主机都会收到，如何辨别哪个是发给我的呢？【主机编址问题，如MAC地址】。【注：MAC 地址】**网卡上的 MAC 地址**：主机在网络中的地址。这样发送的数据附加上目的地址，其他主机收到后，根据自身地址和目的地址决定是否接受数据。

3. 既然目的主机收到了信息，如何区分报文信息和地址信息？【分组的封装格式问题】

4. 另外，如果几台主机同时向主机发送信息，会产生碰撞，如何协调各主机争用总线？尽管总线早已淘汰，目前使用以太网交换机，但这又是怎么实现的？

> 这三个问题被划归到**数据链路层**。上面我们彻底解决了两台主机间的通信！但是，对于互联网上成千上万的主机，只靠这两层还是无法正常工作。

> 我们继续拓展，现在我们的网络成了一个 三个路由器 四个网络 组成的小型互联网。

![nes03.png](/images/net/nes03.png "小网络"){: .align-center}

5. 此前只有一个网络，我们不需要标识网络。然而现在有四个网络，如何**标识各网络以及各网络中的主机**？【网络和主机共同编址问题，如 IP 地址】：图中前三个表示网络 N1 （192.168.1），最后一个标识主机（254：路由器接口，1：笔记本，2：服务器）。

6. 显然图上从源主机到目的主机的路径不止一条，那么路由器如何转发分组？如何选择路由？

> 这两个问题被划归到**网络层**。现在我们已经可以实现分组在小网络间传输了！不过对于网络应用而言还不够。

7. 网络中有一个主机，运行着浏览器进程和 QQ 进程，有个服务器运行着服务器进程，某个时刻，主机收到了来自服务器的分组，那么这些分组应该由浏览器进程处理，还是QQ进程处理？【如何解决与网络通信相关的应用进程？】，进而解决进程之间基于网络通信的问题。

8. 出现传输错误 如误码，又该如何处理？

> 最后两个问题被划归给运输层解决。现在，我们终于可以实现**进程**之间基于网络的通信了！

最后，只需制定各种**应用层**协议，并按协议标准编写**应用程序**，通过**进程间的交互**来完成特定的网络应用。如浏览网页的 HTTP ， 发邮件的 SMTP 协议， 文件传输的 FTP 协议等。

### 【重要】总结各层的作用和作用范围

现在，结合这个例子，我们总结一下这五层解决的主要问题，图片显示每层在计算机网络中起到什么**作用**。同时还有各层实际的**作用范围**，越高层作用范围也越大。

![nes04.png](/images/net/nes04.png "回看一下五层协议"){: .align-center}

我们已经解决了实现计算机网络的各种主要问题，显然这种逐模块实现的思想是必要的。

----------------
### 3）计算机网络体系结构分层思想举例

演示一下分组 **逐层封装和解封**的过程：

![nes05.png](/images/net/nes05.png "分层处理方法"){: .align-center}

进程之间的通信 分层处理方法与栈类似：首先，主机的 HTTP 报文自应用层向下逐步加入首部，到数据链路层成为帧，到物理层被看作比特流，加入前导码，变换成信号发给传输媒体，到达路由器。

路由器只有三层（物理层，链路层，网络层），接收到信号变成比特流，去掉前导码变成帧，去掉帧的首尾变成IP数据报，网络层解析并提取出目的网络地址，查找自身路由表确定转发端口进行转发。接下来继续封装，向下逐步加入首部，传输给服务器。

服务器逐步去掉首尾，最后应用层得到了主机的 HTTP 请求报文，进行解析，给主机发回响应报文。

-----------------------------

### 4）计算机网络体系结构中的专用术语

术语来自OSI七层结构，也适用于TCP/IP四层和五层原理。

#### 1. 实体
- **实体**：任何可发送或接收信息的**硬件或软件进程**；
- **对等实体**：通信双方**相同层次中的实体**。实际例子：通信双方的网卡，双方的应用进程等，如图。

![nes06.png](/images/net/nes06.png "实体"){: .align-center}

#### 2. 协议
- 控制两个**对等实体进行逻辑通信**的规则的集合；比如应用层对等实体在应用层**协议**控制下通信。

![nes07.png](/images/net/nes07.png "协议"){: .align-center}

- 【注意】之所以叫逻辑通信，是因为这种通信其实是假设出来的，实际不存在。目的在于方便我们单独研究体系结构中某一层，不用考虑其他层。例如研究运输层时，假定运输层实体在进行逻辑通信，而不用顾及其他层。
- 协议的三要素：**语法，语义，同步**；
    - **语法**：定义所交换信息的格式。即所交换信息由哪些字段及什么顺序构成；
    - **语义**：定义通信双方要完成的操作。如HTTP语义规定主机发送请求，服务器返回响应；
    - **同步**：定义通信双方的时序关系。不是时钟频率同步，而是建立连接，如TCP的三报文握手建立连接的过程，如下：

![nes08.png](/images/net/nes08.png "TCP协议——同步"){: .align-center}

------

#### 3. 服务
- **每层为相邻上层提供服务**：在协议的控制下，两个对等实体间的逻辑通信使得本层能够**向上一层提供**服务。例如，物理层对等实体在物理层协议的控制下向数据链路层提供服务。
- 相应的，要实现本层协议，还需要**使用下面一层所提供**的服务。如：数据链路层对等实体享受物理层提供的服务，同时又和对等实体进行逻辑通信，为网络层提供服务。

![nes09.png](/images/net/nes09.png "服务：一享受一提供"){: .align-center}

- 显然，协议是“水平的”，而服务是“垂直的”，图中也清晰地体现了这一点。
- 实体看得见相邻下层所提供的服务，但并不知道实现该服务的具体协议，即：下面的协议对上面的实体是**透明的**。比如：我们看得见手机提供的服务，我们享受手机提供的服务，但没必要知道实现服务的原理。
- **服务访问点**：同一系统中**相邻两层的实体交换信息的逻辑接口**，用于区分**不同服务类型**。（不然怎么知道谁给谁提供的服务？）
    - 数据链路层的服务访问点为**帧的“类型”**字段；
    - 网络层的服务访问点为IP数据报首部中的“**协议字段**”；
    - 运输层的服务访问点为“**端口号**”；

![nes10.png](/images/net/nes10.png "PDU, SDU"){: .align-center}

- **服务原语**：上层使用下层所提供的服务，必须通过**与下层交换一些命令**，这些命令称为服务原语。
- **PDU**：对等层次之间（**水平**）传送的数据包，称为**该层的协议数据单元 PDU** 。（就是消息到了这一层叫什么？）例如：
    - 物理层的 PDU 叫**比特流**
    - 链路层的 PDU 叫**帧**,..., 
    - 剩下的在图中；
    - 这些统称PDU ；
- **SDU**：同一系统内，层与层之间（**垂直**）交换的数据包称为**服务数据单元 SDU** 。
- 多个SDU可以合成一个PDU，一个SDU也可划分多个PDU。

-------

### 5）其他概念

**端到端 end-to-end**：

![def01.png](/images/net/def01.png "端到端"){: .align-center}

图中显示了数据链路层，网络层和运输层各自的作用范围。显然只有运输层解决了进程之间基于网络的通信问题，也就是第一个提供端到端服务的层次。

------

