---
layout: post
title: "计网 Ch6：应用层"
author: LJC
tags:
- network
date: 2022-11-03 15:40 +0800
toc: true
---

# 应用层 (Application layer) 

## 1. 应用层概述

应用层享受其下各层提供的服务，解决通过应用进程的交互来**实现特定网络应用的问题**。

应用层作为最顶层，是**设计和建立计算机网络的最终目的**，也是计网中发展最快的部分。
- 早期基于文本的应用（电子邮件，远程登陆，文件传输，新闻）；
- 万维网 www；
- 即时通信，P2P 文件共享，音视频应用；
- 新型网络应用；

接下来以一些经典的网络应用为例，来学习有关**网络应用**的原理，协议和实现方面的知识。

- ![app01.png](/images/net/app01.png "经典的网络应用")

--------------

## 2. 客户-服务器(C/S) 方式 和 对等(P2P) 方式

网络应用程序运行在处于网络边缘的不同端系统上，通过彼此间的通信来共同完成某项任务。

因此开发一种网络应用，首先要考虑的问题是**网络应用程序在各种端系统上的组织方式 和 它们之间的关系**。目前流行的主要有以下两种：
- **客户-服务器** (Clien t/ Server) 方式
- **对等** (Peer-to-Peer) 方式

### 客户-服务器

客户 和 服务器 是指通信中所涉及的**两个应用进程**。这种方式描述的是进程之间的 **服务和被服务的关系**。它是因特网上传统的，最成熟的方式，很多应用都是这种方式，如www，电子邮件等。

- 如图，首先明确一下概念：
    - 主机 A 运行客户程序，正在运行的客户程序称为客户进程/ 客户
        - 运行客户进程的主机称为客户计算机，有时也可简称为客户（区分）；
    - 主机 B 运行服务器程序，正在运行的服务器程序称为服务器进程/ 服务器，
        -  运行服务器进程的主机称为服务器计算机，有时也可简称为服务器；
    - ![app02.png](/images/net/app02.png "客户 和 服务器")

<br/>

- 在 客户-服务器 方式下，客户向服务器请求服务，服务器收到请求后向客户提供服务；
    - 客户是服务请求方
    - 服务器是服务提供方
    - **服务器总是处于运行状态**，并等待客户的服务请求。**服务器具有固定运输层端口号**（如HTTP服务器的默认端口号80），而**运行服务器的主机也具有固定的 IP 地址。**

- 基于C/S方式的应用服务通常是**服务集中型**的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上。
    - 不过，由于一台服务器给多个客户机提供服务，实际应用中**常会出现服务器跟不上众多客户机请求的情况**；
    - 为此，在C/S应用中常用**计算机群集**（服务器场）构建一个强大的**虚拟服务器**。

###  对等方式

对等方式 **没有固定的服务请求者和服务提供者**，各应用进程是对等的，称为**对等方**，它们**相互直接通信**，每个对等方既是服务请求者，又是服务提供者。

- 例如某种网络下载工具软件P2P下载器，如图，E 的 P2P进程正在从 F 下载文件，同时还为D的P2P进程提供下载服务。
    - ![app03.png](/images/net/app03.png "对等方式")

- 基于 P2P 的应用是**服务分散型**的，因为应用服务不是集中在少数几个服务器计算机，而是分散在大量对等计算机中，这些计算机不为ISP所有，而是为个人控制的台式机/笔记本，常位于住宅，校园，办公室等。
- P2P 方式最突出之一是它的**可拓展性**。系统每增加一个对等方，不仅增加了请求者，还增加了服务提供者，**系统性能不会因规模增大而降低**。
- P2P 具有**成本**上的优势，因为它不需要服务器和带宽。

--------------------

## 3. 动态主机配置协议 DHCP

DHCP 是 TCP/IP 协议体系中应用层的协议，它使用运输层的 **UDP** 提供的服务

### DHCP 的作用：自动给各主机配置信息

看如下场景：如何配置用户主机才能使 用户主机正常访问Web服务器？
- ![dhcp01.png](/images/net/dhcp01.png "DHCP场景")

正确配置 IP 地址，子网掩码，默认网关，DNS 服务器等网络相关配置信息。我们可以手工配置，如图：但是网络中主机较多，就不能一个一个配了，而且容易出错！
- ![dhcp02.png](/images/net/dhcp02.png "DHCP场景")

如果给网络中添加一台 **DHCP 服务器**，并在该服务器中设置好 网络中其他各主机的网络配置信息 怎么配，其他主机开机后，自动启动DHCP程序，向DHCP服务器请求自己的网络配置信息，这样网络中各主机都可以从 DHCP 服务器**自动获取**网络配置信息，而不用一个一个手工配置了。
- ![dhcp03.png](/images/net/dhcp03.png "DHCP场景")

### DHCP 的六大工作流程

假设网络中有两台 DHCP 服务器和多台用户主机，下面以一台主机为例：
![dhcp04.png](/images/net/dhcp04.png "DHCP工作场景")

- DHCP 使用客户-服务器方式：
    -  DHCP 服务器上运行 DHCP 服务器进程，可简称为 DHCP 服务器；
    -  用户主机上运行 DHCP 客户进程，可简称为 DHCP 客户；

- 由于用的是 UDP 协议， DHCP 报文在运输层被封装成 UDP 用户数据报，在网络层封装成 IP 数据报，再根据所用的**网络接口**封装成数据链路层的帧进行发送（例如以太网帧），后面不再赘述逐层封装的过程，其中：
    - DHCP **服务器**使用的 UDP 端口是 **67**；
    - DHCP **客户**使用的 UDP 端口是 **68**；都是熟知端口；

**下面看看 DHCP 客户与 DHCP 服务器的交互过程：**

**（一）DHCP 发现报文 (DHCP DISCOVER)**

启用主机的 DHCP 后，DHCP 客户将**广播发送 DHCP 发现报文 (DISCOVER)**：

- IP 数据报中：
    - 其源 IP 地址为0.0.0.0（因为主机当前还未分配到 IP 地址，用 0 代替）
    - 目的 IP 地址为 255.255.255.255 （广播）
- 之所以**广播**，是因为主机现在并不知道网络中有哪几个 DHCP 服务器，以及它们的 IP 地址。
- ![dhcp05.png](/images/net/dhcp05.png "DHCP工作场景")

<br/>

广播域中的所有设备都会收到该 IP 数据报（应用层是DHCP 发现报文），并对其层层解封，解封出封装有 DHCP 发现报文的 UDP 用户数据报。该 UDP 用户数据报目的端口是 67（DHCP 服务器进程）。
- DHCP 客户 的应用层没有 监听端口 67 的进程，UDP 无法交付，丢弃；
- DHCP 服务器 的应用层运行着 DHCP 服务器进程，接收 DHCP 发现报文并作出响应；
    -  DHCP 发现报文细节不讨论，只知其封装了 **事物ID** 和 **DHCP客户端的 MAC 地址**；
- ![dhcp06.png](/images/net/dhcp06.png "DHCP工作场景")

<br/>

**（二）DHCP 提供报文 (DHCP OFFER)**

**服务器** 收到DHCP发现报文后，根据其中封装的 DHCP客户端的 MAC 地址 来查找自己的**数据库**，看是否有针对该 MAC 地址的配置信息；
- 如果有，使用**相应的配置信息** 构建并发送 **DHCP 提供报文 (OFFER)**；
- 如果没有，采用**默认配置信息** 构建并发送 DHCP 提供报文；
- **DHCP 提供报文 (OFFER)**的源 IP 地址为服务器地址，目的地址仍然是**广播地址**；
    - 这是因为客户机目前还没有配置 IP 地址，只能广播发回客户；
- ![dhcp07.png](/images/net/dhcp07.png "DHCP工作场景")

<br/>

广播域中的所有设备都会收到 DHCP **提供**报文的 IP 数据报，并对其层层解封，解封出封装有 DHCP 提供报文的 UDP 用户数据报。服务器广播的提供报文的目的端口是 68 （DHCP 客户进程端口号）：
- DHCP 服务器 的应用层没有 监听端口 68 的进程，UDP 无法交付，丢弃；
- DHCP 客户 的应用层运行着 DHCP 客户进程，接收该 DHCP 提供报文，并作出响应；
- DHCP 客户根据 DHCP 提供报文中的**事务 ID** 来判断该报文是否 **是自己所请求的**报文；
    - 如果该事务 ID 与自己之前发送的 DHCP 发现报文中的 事务 ID 相等，表明这就是自己刚向服务器请求的报文，可以接受，否则丢弃。
        - 提供报文 中，还封装有 配置信息（IP地址，子网掩码，地址租期，默认网关，DNS服务器等）
        - 其中对于 IP 地址，DHCP 服务器在地址池中 给客户挑选给主机租用哪个 IP 地址时，会**使用 ARP 确保所选 IP 地址未被网络中其他主机占用**；
- ![dhcp08.png](/images/net/dhcp08.png "DHCP工作场景")

<br/>

**（三）DHCP 请求报文 (DHCP REQUEST)**

对于本例，两个 DHCP 都会广播给主机它们挑选的 IP 地址，客户验证事务 ID发现是给自己的，并从中选择一个（一般选择先到的那个），然后客户向所选择的 DHCP 服务器发送 **DHCP 请求报文(DHCP REQUEST)**。
- 封装 请求报文 的 IP 数据报的源 IP 地址仍为 0.0.0.0 ，因为此时客户才从多个 DHCP 服务器中挑选一个作为自己的 DHCP 服务器。客户首先需要征得服务器的同意，才能正式使用服务器给它租用的 IP 地址，所以还用着 0.0.0.0 ；
- 目的 IP 地址仍为广播地址，无需向每一个服务器单独发送 DHCP 请求报文来通知是否请求它们作为自己的 DHCP 服务器；
- DHCP 请求报文中封装有 事务 ID，DHCP 客户的 MAC地址，接受租约中的 IP 地址，提供此租约的服务器端的 IP 地址等信息。
- ![dhcp09.png](/images/net/dhcp09.png "DHCP工作场景")

<br/>

**（四）DHCP 确认报文 (DHCP ACK)**

对于本例，假设选择 服务器1 作为自己的 DHCP 服务器，而且服务器1 接受了该请求，那么服务器1 给 客户发送 **DHCP 确认报文 (ACK)**：
- 封装 确认报文 的 IP 数据报的源 IP 地址为 DHCP 服务器1 的 IP地址；
- 目的 IP 地址仍为广播地址；
- ![dhcp10.png](/images/net/dhcp10.png "DHCP工作场景")

<br/>

**（五）DHCP 谢绝报文 (DHCP DECLINE)**

DHCP 客户收到该确认报文后，就可以使用所租用到的地址了。使用之前还要注意：主机还会使用 ARP 协议检测该IP 地址是否已被其他主机占用：
- 如果被占用：客户给 DHCP 服务器发送 **DHCP 谢绝报文 (DECLINE)**，来谢绝 IP 地址租约，并**重新广播** DHCP 发现报文；
- 未被占用：则可以使用租约中的 IP 地址与其他主机通信；

**（六）租用期过半后**

当租用期过半时，客户向服务器发送 **DHCP 请求报文 (DHCP REQUEST)**，来更新租用期。
- 封装 该报文 的 IP 数据报的源 IP 地址为 客户之前租用到的 IP 地址；
- 目的 IP 地址为 DHCP 服务器1 的地址；
- ![dhcp11.png](/images/net/dhcp11.png "DHCP工作场景")

DHCP 服务器的反应：
- 若同意，则发回 **DHCP 确认报文 (DHCP ACK)**，这样客户就得到了新的租用期；
    - ![dhcp12.png](/images/net/dhcp12.png "情况1")
- 若不同意，则发回 **DHCP 否认报文 (DHCP NACK)**，客户必须立即停止使用之前租用的 IP 地址，并重新发送 DHCP 发现报文重新申请 IP 地址；
    - ![dhcp13.png](/images/net/dhcp13.png "情况2")
- 若 DHCP 服务器**未作出响应**，则在 租用期过了 87.5% 时，客户必须重新发送DHCP 请求报文 (DHCP REQUEST)，然后继续等待 服务器可能的反应：
    - 若**响应**了，按上面的同意/ 不同意处理；
    - 若还是**未响应**，则 租用期到期后，客户必须立即停止使用之前租用的 IP 地址，并重新发送 DHCP 发现报文重新申请 IP 地址；
    - 【注意】客户可以随时提前终止 DHCP 服务器所提供的租用期，这时只需要向 DHCP 服务器发送 **DHCP 释放报文 (DHCP RELEASE)** 段即可；
    - ![dhcp14.png](/images/net/dhcp14.png "DHCP工作场景")

综上所述，整个过程分为：
- DHCP 客户 寻找服务器
- 服务器提供 IP 地址租用
- 客户接受 IP 地址租约
- 服务器确认 IP 地址租约
- IP 地址续约
- 客户随时解除 IP 地址租约
- ![dhcp15.png](/images/net/dhcp15.png "DHCP工作全过程")

其中**两次用到了 ARP 协议**，一次是服务器在地址池中挑选 IP 地址时用 ARP 挑选别人没用过的 IP ，另一次是客户正式租用地址之前也会使用 ARP 来检测该 IP 是否被其他主机占用。

### DHCP 中继代理：由于路由器隔离广播域

如图，黄色区域的两个主机不能自动获取到 IP 地址等网络配置信息，因为路由器隔离了广播域。
- ![dhcp16.png](/images/net/dhcp16.png "DHCP中继代理的场景")

解决方法是给路由器配置 DHCP 服务器的 IP地址，并使其成为 DHCP 中继代理。

由于配置了路由，收到广播转发给另一个广播域的DHCP服务器；
- ![dhcp17.png](/images/net/dhcp17.png "DHCP中继代理")

使用中继代理（如路由器）的原因是：我们并不会给每个网络都设置一个 DHCP 服务器，这样DHCP 服务器就太多了。

------------------------

## 4. 域名系统 DNS (Domain  Name System)

### DNS 的作用

主机要访问某台 web 服务器，只需要在主机中运行某个**浏览器**软件，在其地址栏中输入要访问的web服务器的**域名**，即可访问到 web 服务器提供的内容。
- ![dns01.png](/images/net/dns01.png "DNS")

再看这个，ping [北航的域名](https://www.buaa.edu.cn/)，但能看到实际上 ping 的是该 web 服务器的IP地址：
- ![dns02.png](/images/net/dns02.png "DNS")

这也再次对应了 TCP/IP 是使用 IP 地址进行寻址的，即：不用域名，只用IP地址也可以通过IP地址来寻址目的主机，但显然是域名更好记。因此一般使用域名，而不是IP地址来访问目的主机。

对于本例，当在浏览器中输入某个web服务器的域名时，主机首先在自己的DNS高速缓存中查找该域名对应的 IP 地址。如果没找到，则向网络中的某台 DNS 服务器查询，**DNS 服务器中有域名和IP地址映射关系的数据库**。
- ![dns03.png](/images/net/dns03.png "DNS的作用")

DNS 服务器收到 DNS 查询报文后，在其数据库中查询，然后将查询结果（域名对应的 IP地址）发给用户主机，现在主机就可以通过web服务器的IP地址，对其访问了。

> 那么因特网是否可以只用一台 DNS 服务器呢？

理论可行，但实际不可取。因特网规模很大，这么大的域名服务器肯定因为负荷而无法工作，一旦域名服务器出现故障，整个因特网就会瘫痪。因特网早在 1983 就用层次结构的命名树作为主机名（域名），并使用分布式的域名系统 DNS。**DNS使大多数域名都在本地解析，仅少量解析需要在因特网上通信，因此效率很高**。而且由于是分布式系统，即使单个 DNS 服务器出现故障，也不会妨碍整个系统正常运行。
<br/>

### 因特网的域名结构

因特网采用**层次树状结构的域名结构**：
- 域名结构由若干分量组成，各分量之间用 点【**.**】 隔开，分别代表不同级别的域名；
    - 不同级别的域名：
    - ![dns04.png](/images/net/dns04.png "域名")
    - 每一级的域名都由英文字母和数字组成，不超过 63 个字符，**不区分大小写字母**；
    - 级别最低的域名在最左，级别最高的顶级域名在最右；
    - 完整的域名不超过255个字符；
- 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级域名代表什么意思；

- 各级域名由其上一级的域名管理机构管理，最高的顶级域名由 ICANN 管理。
    - ![dns05.png](/images/net/dns05.png "北航邮箱域名")

<br/>

**顶级域名 TLD** (Top Level Domain) 分为以下三类：
- 顶级域名 ：
    - **国家**顶级域名 nTLD ：如 cn 表示中国，us 表示美国等；
    - **通用**顶级域名 gTLD ：常用七个：com（公司企业），net（网络服务机构），org（非营利性组织），int（国际组织），edu（美国教育机构），gov（美国政府部门），mil（美国军事部门）；
    - 反向域 arpa ：用于反向域名解析，即 IP 地址反向解析为域名；
- 在国家顶级域名下注册的二级域名均有该国家自行确定。例如顶级域名为 jp 的日本，将其教育和企业机构的二级域名定为 ac 和 co，而不用 edu 和 com；
- **我国 二级域名**划分为以下两类：
    - 类别域名 共七个：ac（科研机构）、com（工、商、金融等企业）、edu（教育机构）、gov（政府部门）、net（提供网络服务的机构）、mil（军事机构）、org（非营利性组织）。
    - 行政区域名 34个：用于各省，直辖市，如 bj 为北京市，sh 为上海市等；
    - 【注意】顶级域名com和我国企业域名com，名称相同等级不同；

因特网的域名空间：
- ![dns06.png](/images/net/dns06.png "因特网的域名空间")

**这种按等级管理的命名方法便于维护名字的唯一性，也容易设计出一种高效的域名查询机制。但域名只是个逻辑概念，并不代表计算机的物理地点。**

域名 和 IP 地址的映射关系必须保存在域名服务器中，以供所有其他应用查询。不能都存在一个服务器中，DNS 使用 **分布在各地的域名服务器** 来实现 域名到 IP 地址的转换。

域名服务器可划分为以下四种不同类型：
- **根域名服务器**：最高层次的域名服务器，每个根域服务器都知道所有的顶级域名服务器的域名及其 IP 地址。因特网共有 13 个不同 IP 地址的根域名服务器（实际以服务器群集的形式）；
    - 本地域名服务器向根域名服务器发出查询请求时，路由器就把查询请求报文 转发到离这个 DNS 客户最近的一个根域名服务器，这样加快了DNS查询过程，合理利用资源。
    - **根域名服务器通过不直接对域名解析，而是返回该域名所属顶级域名的顶级域名服务器的 IP 地址**；
- **顶级域名服务器**：复杂**管理在该顶级域名服务器注册的所有二级域名**。收到 DNS 查询请求时就给出相应的回答（可能是最终结果，也可能是下一级 权限域名服务器 的 IP 地址，视URL）
- **权限域名服务器**：管理某个区的域名。每个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管辖的域名与 IP 地址的映射关系。
    - 另外，权限域名服务器还知道其 下级域名服务器的地址；
- **本地域名服务器**：不属于上述域名服务器的等级结构。当一个主机发出 DNS 请求报文时，这个报文首先被送往该主机的本地域名服务器。
    - **本地域名服务器起代理的作用，会将该报文转发到上述的域名服务器的等级结构中**。
    - 每个 ISP ，大学等都可以有一个本地域名服务器，有时也称**默认域名服务器**。
    - 本地域名服务器 离用户较近，一般不超过几个路由器的距离，甚至在一个局域网中；
    - 本地域名服务器 的 IP 地址需要直接配置在需要域名解析的主机中；

---------------

### 域名解析（递归 / 迭代） ，高速缓存

如图，左为递归查询，右为迭代查询：
- ![dns07.png](/images/net/dns07.png "递归查询")
- 递归查询：查询结果会在 之前受委托的各域名服务器 之间传递，最终传回给用户主机：
- 迭代查询，一次查到一个服务器，再向新服务器查询，显然这种方式对被查询的域名服务器负担太大，通常采用图中的模式：从请求主机到本地域名服务器的查询是递归查询，而其余的查询是迭代查询；
- DNS 报文使用 **UDP** 协议封装，运输层**端口号为 53**。

**高速缓存**：避免迭代/递归查询，在本地留有记录：

- 为了提高  DNS 查询效率，并减轻根域名服务器的负荷和减少因特网上的 DNS 查询报文数量，在域名服务器中广泛地使用了**高速缓存**。高速缓存用来存放最近查询过的域名，以及从何处获得域名映射信息的记录；
- ![dns08.png](/images/net/dns08.png "迭代查询")

- 不过，域名到 IP 地址的映射关系并不是永久不变的，为保持高速缓存中的内容正确，域名服务器**应为每项内容设置计时器**，并删除超时项（比如 两天）；
- 本地域名服务器需要高速缓存，用户主机也很需要高速缓存。许多用户主机在启动时从本地域名服务器下载域名和 IP 地址的全部数据库，**维护**存放自己最近使用的域名的**高速缓存**，并且只 在缓存里找不到域名时 才向服务器查询。主机也要保持高速缓存的正确性。

最后举个例子，对于 [buaa.edu.cn](https://www.buaa.edu.cn/) ，一个本地 DNS 服务器可能查询0次（高速缓存里有），也可能查询4次（根 → cn → edu → buaa）。

----------------

## 5. 文件传输协议 FTP（两通道分别传命令和数据）

将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，即文件传送。**文件传送协议 FTP** (File Transfer Protocol) 是因特网上使用的最广泛的文件传送协议。
- FTP **提供交互式的访问**，允许客户**指明文件的类型和格式**（比如是否使用ASCII码），并允许**文件具有存取权限**（如访问文件的用户必须经过授权，并输入有效口令）；
- **FTP 屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件**；

如图，FTP 采用 客户-服务器 方式，FTP 客户计算机可将各种类型的文件上传到 FTP 服务器计算机。客户机也可以从服务器下载文件。
- ![ftp01.png](/images/net/ftp01.png "FTP")

根据应用**需求的不同**，FTP 服务器可能需要一台高性能，高可靠性的服务器计算机，也可能只需要一台普通的个人计算机即可。

简单起见，假设客户和服务器在同一个局域网中。首先在选定的 计算机 中创建 FTP 服务器，可以用第三方的 FTP 服务器软件，也可以用操作系统自带的 FTP 服务器软件。例如在 win 系统中用其自带的FTP服务器功能 创建一个 FTP 服务器站点。
- ![ftp02.png](/images/net/ftp02.png "FTP")

如图，客户可以用浏览器和 IP 地址访问该服务器【注意用的不是HTTP】，也可以用命令行，但需要记住相关命令，第三方的 FTP 客户工具软件则有图形界面。
- ![ftp03.png](/images/net/ftp03.png "FTP命令")

FTP 的常见用途是在计算机之间传输文件，尤其是**批量传输**。另一个常见用途是让网站设计者将大量网站设计文件批量上传到 web 服务器。

### FTP 基本工作原理：主动/ 被动

**（一）建立命令通道**

服务器监听 端口号21 ，客户随机选一个临时端口号建立 TCP 连接，传送 FTP控制命令，即 **命令通道/ 控制连接**。
- ![ftp04.png](/images/net/ftp04.png "FTP命令通道")
- 【注意】**控制连接** ：
    - 整个会话期间**一直打开**；
    - 传送 FTP 相关的**控制命令**。

**（二）主动 建立数据通道**

有数据要传输时，客户通过命令通道 告知服务器与自己 **另一个临时端口号** 建立 TCP 连接，建立**数据通道**。注意数据通道是服务器主动连接客户，也是**主动模式**（服务器发起）。
- ![ftp05.png](/images/net/ftp05.png "FTP数据通道-主动模式")
- 【注意】**数据连接** ：
    - 在每次文件传输时才建立，传输结束了就关闭；
    - 传送 **文件数据**。

**（三）被动 建立数据通道**

命令通道建立和主动模式一样，只是有数据要传输时，客户（通过命令通道）告知 **服务器打开某个临时端口被动等待 FTP 连接**，以建立数据通道，即**被动模式**（客户发起）。
- ![ftp06.png](/images/net/ftp06.png "FTP数据通道-被动模式")

<br/>

总之，客户 和 服务器之间要建立 **控制连接 和 数据连接** 这两个并行的 TCP 连接。
- 控制连接一直打开，数据连接用到了才打开，用完了关闭；
- 控制连接传送命令，数据连接传送数据；
- 端口号：TCP21 控制连接； 主动（20），或被动（临时号） 数据连接；

--------------------------

## 6. 电子邮件 E- mail

E- mail 是因特网上最早流行的应用。与实时通信不同，电子邮件类似邮政，方便迅速低成本。电子邮件系统采用 客户/服务器 方式。三个主要组成构件：**用户代理，邮件服务器，电子邮件所需的协议**。
- 用户代理：用户与电子邮件系统的**接口**，又称为**电子邮件客户端软件**。发送方需要用户代理发送，接收方需要用户代理接收；
- 邮件服务器：电子邮件系统的基础设施。所有 ISP 都有邮件服务器，其功能是**发送和接收邮件**，以及**维护用户的邮箱**。
- 协议包括：邮件**发送协议**和**读取协议**。例如 SMTP发送 ，POP3，IMAP 读取。
- ![em01.png](/images/net/em01.png "电子邮件 E- mail")

<br/>

**邮件发送和接收过程**

发送方的用户代理 作为 STMP 客户，与发送方邮件服务器中的 SMTP 服务器进行 **TCP 连接**，基于此连接用 SMTP 协议给服务器发邮件；
- ![em02.png](/images/net/em02.png "发送和接收过程-1")

发送方邮件服务器 中的 SMTP 客户与 接收方邮件服务器中的 SMTP 服务器进行 **TCP 连接**，基于此连接用 SMTP 协议给服务器 发 待转发邮件给接收方邮件服务器；
- ![em03.png](/images/net/em03.png "发送和接收过程-2")

接收方的用户代理作为 POP3 客户，与 接收方邮件服务器中的 POP3 服务器进行 **TCP 连接**，基于此连接用 POP3 协议从接收方邮件服务器读取邮件。
发送邮件的全过程如下：
- ![em04.png](/images/net/em04.png "发送和接收过程-3")

### SMTP，MIME (发送)与 POP3，IMAP (接收)

**简单邮件传送协议 SMTP** (Simple Mail Transfer Protocol)属于TCP/IP协议族，其基本工作原理如下：

以下图为例。发送方邮件服务器 周期性扫描邮件缓存（如30min），如发现有邮件，则发送方邮件服务器中的SMTP 客户与 接收方邮件服务器的 SMTP服务器进行 TCP连接，**端口号25**；
- 然后客户给服务器发送SMTP命令，共 14 条；
- 服务器给客户相应的应答，共 21 种；
- ![em04.png](/images/net/em04.png "简单邮件传送协议 SMTP")
- 通过这种 命令与应答 的交互方式，最终实现客户给服务器发送邮件。

TCP连接建立成功后，整个过程如下：
- ![smtp01.png](/images/net/smtp01.png "简单邮件传送协议 SMTP全过程")

<br/>

**电子邮件的信息格式**

电子邮件的信息格式并不是 SMTP 定义的，而是在 RFC 822 中定义的。一个电子邮件有**信封和内容两部分**，**内容又由首部和主体两部分**构成。
- ![smtp02.png](/images/net/smtp02.png "简单邮件传送协议 SMTP全过程")
- 首部里有关键字需要用户填写；
- 信封上的信息由邮件系统自动从首部提取并填写，不需要用户填；
- 主体是核心信息

**STMP 协议只能传送 ASCII 码文本数据**，不能传送可执行文件等其他的二进制对象，不能传音视频，图片，中俄文等。为解决这个问题，提出了**多用途因特网邮件拓展 MIME** (Multipurpose Internet Mail Extensions)，可以将非 ASCII 码数据转换成 ASCII 码数据，然后就可以用 SMTP 传送了：
- ![smtp03.png](/images/net/smtp03.png "SMTP增强")

为了实现转换，MIME：
- **增加了 5 个新的邮件首部字段**，提供邮件主体的信息；
- 定义了**许多邮件内容的格式**，对多媒体电子邮件的表示方法进行标准化；
- 定义**传送编码**，对任何内容形式进行转换；

MIME 不只用于 SMTP ，**也用于**同样面向 ASCII 码字符的 **HTTP**。

<br/>

**POP3 和 IMAP4：获取邮件的协议**

- **邮局协议 POP** (Post Office Protocol)，POP3 是其第三个版本，是因特网正式标准。
    - 简单，功能有限的邮件读取协议，用户只能以 **下载并删除方式** 或 **下载并保留方式**从服务器下载到计算机；
    - **不允许用户在邮件服务器上管理自己的邮件**（如创建文件夹，对邮件分类管理等）；

- **因特网邮件访问协议 IMAP** (Internet Message Access Protocol)，IMAP4 是第四个版本，目前只是因特网建议标准。
    - 功能比 POP3 更强大，**用户在自己主机上 就可以操控邮件服务器中的邮箱**，因此 IMAP 是一个联机协议；

- POP3（端口110） 和 IMAP4（端口143）都采用 **基于 TCP 连接的客户/服务器方式**。

<br/>

**基于万维网的电子邮件：**
- 通过**浏览器**登录（用户名和口令）**邮件服务万维网网站**就可以撰写，收发，阅读和管理电子邮件。不同的是无需安装用户代理程序，只需要浏览器。
- 与 IMAP 很类似，不用下载邮件到本地就能管理；

如图，相同的邮件网站和不同邮件网站，不同邮件之间需要 STMP 协议。
- ![smtp04.png](/images/net/smtp04.png "基于万维网的电子邮件")

-----------------------------

## 7. 万维网 WWW

万维网 WWW (World Wide Web) **并非某种特殊的计算机网络**，它是一个大规模的，联机式的信息储藏所，是**运行在因特网上的一个分布式应用**。万维网作为因特网提供的服务/应用，它是无数个网络站点和网页的集合，构成了因特网主要的部分。万维网利用网页之间的 **超链接** 将不同网站的网页链接成一张逻辑上的信息网。

万维网由浏览器浏览连超文本页面组成，浏览器最重要的部分是**渲染引擎**，也就是**浏览器内核**，负责对网页内容进行解析和显示。网页的开头部分总是 http:// 或者 https:// ，表明被浏览器的信息是超文本，是利用超文本传输协议 HTTP 来传输的。
- 不同浏览器内核对网页内容的解析有所不同，因此同一网页在不同内核的浏览器下的显示效果可能不同；
- 网页编写者需要在不同内核的浏览器中测试网页显示效果；

典型的万维网应用：输入域名并回车，浏览器发送请求报文给服务器，服务器发回响应报文，浏览器解析并渲染网页内容，就可以看到网站了。

<br/>

### 统一资源定位符 URL

为了方便地访问在世界范围的文档，万维网使用 **统一资源定位符 URL** 来指明因特网上任何种类资源的位置。URL 的一般形式有以下四个部分：
- ![www01.png](/images/net/www01.png "URL")

此前的域名是 **buaa.edu.cn** ，对应的 URL 则是 【**http://www.buaa.edu.cn:80/index.htm**】
- ![www02.png](/images/net/www02.png "URL")

点击其页面上的超链接，其协议，主机，端口不变，不同的是路径和网页文件
- ![www03.png](/images/net/www03.png "URL")

【**域名和 URL 的区别**】：域名只是一个网站的标识，不可以直接访问网站，只有当域名经过解析之后，这个域名才能成为一个URL(网址)。URL (网址) 包含域名，是Internet上的地址簿，通过URL可以到达任何一个网站页面。

<br/>

### 万维网文档：HTML，CSS，JS 文件

可以将网页（如首页）另存为文件，如图：
- ![www04.png](/images/net/www04.png "万维网文档")

可以看到有 HTML 文档，css 文档，JavaScript文档，图片文件等。
- **超文本标记语言 HTML (HyperText Markup Language) **：使用多种 **标签** 来描述**网页的结构和内容**；
- **层叠样式表 CSS (Cascading Style Sheets)**：从审美的角度来描述**网页的样式**；
- **JavaScript** ：一种脚本语言，用来控制网页的行为；

浏览器内核解析和渲染 由 html，css，js 编写的万维网文档（本 Github Pages 项目也是如此）。
- **HTML 文档** 的作用：如下图，**标签** 描述了网页的结构和内容
    - ![www05.png](/images/net/www05.png "万维网文档")
    - 但是上图太简单了，我们可以在 CSS 文档中定义一些所需的样式，对网页内容进行美化： 写一个 css 文档：

- **css 文档** ：定义一种样式（字体大小36像素，颜色深粉色），然后在 HTML 文档中使用 link 标签将该css引入，将样式名称指定给主体中需要更改样式的那个 p 标签。
    - ![www06.png](/images/net/www06.png "万维网文档")
    - 再刷新浏览器，就重新渲染出了网页内容；
    - ![www07.png](/images/net/www07.png "万维网文档")
    - 接下来，我们再给该网页添加一个按钮：在 html 文档中使用 button 标签来添加一个按钮，并为该按钮指定一个发生单击事件时应该调用的处理函数（如图 myFunction），这需要用到js文档；
- **JavaScript 脚本语言** ：编写一个 js 文档。在文档中编写单击事件处理函数的具体实现代码，并在 HTML 文档的首部使用 script 标签，将该 js 文档引入；
    - ![www08.png](/images/net/www08.png "万维网文档")

- 在事件处理函数中，通过元素的 id 来找到相应的元素，也就是显示 hello 的 p 标签，然后更改其显示内容：
    - ![www09.png](/images/net/www09.png "万维网文档")
- 刷新浏览器，就可以看见添加的按钮，当点击按钮后，如图：
    - ![www10.png](/images/net/www10.png "万维网文档")

这些文档的编写属于 web 前端开发的基础，这里不再深入了。注意这些文档都部署在服务器端，有一些是 web **前端**开发设计好的静态页面，一些是服务器**后端**程序根据用户需求自动生成的动态页面，它们都需要从服务器传送给用户浏览器进行解析和渲染，这离不开 HTTP 协议。

### **HTTP 协议**

**超文本传输协议 HTTP** (HyperText Transfer Protocol)：定义了**浏览器**（即万维网客户进程）怎样向万维网服务器**请求万维网文档**，以及万维网服务器怎样把万维网文档传送给浏览器。

如图，用户主机中的浏览器进程（客户进程）与服务器主机中的服务进程基于因特网通信。浏览器进程首先发起与服务器进程的 **TCP 连接**，使用熟知端口号 80 。
- ![http01.png](/images/net/http01.png "HTTP 协议")

基于这条建好的TCP连接，浏览器进程向服务器进程**发送 HTTP 请求报文**，服务器进程收到后，执行相应操作，然后给浏览器进程发回 HTTP 响应报文。
- ![http02.png](/images/net/http02.png "HTTP 协议")

<br/>

- **HTTP /1.0** 采用**非持续连接方式**。在该方式下，每次浏览器要请求一个文件都要与服务器建立 TCP 连接，当**收到响应后就立即关闭连接**。下图是请求和发回万维网文档的示意图。
    - 观察到：请求一个万维网文档所需的时间为 **2RTT + 文档的传输时延**；
    - ![http03.png](/images/net/http03.png "HTTP 1.0")
    - 基于非持续连接的特性，**每请求一个文档就有 2RTT 的时间开销**。若一个网页上有很多引用对象（如图片等文档文件，上面文档节中展示了），那么请求每一个对象都需要花费 2RTT 的时间；
    - 为了减小时延，**浏览器通常会建立多个并行的 TCP 连接同时请求多个对象**，但是这会大量占用万维网服务器的资源，特别在服务器同时服务大量客户需求的情况下负担很重。
<br/>

- **HTTP /1.1** 采用**持续连接**方式，在该方式下，万维网服务器发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上 传送后续的 HTTP 请求报文 和 响应报文。并不局限于传送同一个页面上的引用对象，而是这些文档都在同一个服务器上就可以一直传。
    - 为了进一步提高效率，HTTP/1.1 的持续连接还可以使用**流水线**方式工作，即浏览器在收到响应报文之前，就能连续发送多个请求报文。
    - 这些连续的请求报文到达服务器后，服务器发回一个一个的响应报文，这样节省了很多 RTT 时间，减少 TCP 连接中的空闲时间，提高下载文档的效率；

<br/>

### HTTP 报文格式：【重点】状态码

HTTP 是**面向文本的**，其报文中的每一个**字段**都是一些 **ASCII 码串**，并且**每个字段的长度都是不确定的**。

- HTTP **请求报文**的格式
- ![http04.png](/images/net/http04.png "HTTP 的请求报文格式")

    - 举个例子，方法有很多，如请求URL，环回测试，发送数据等；
    - ![http05.png](/images/net/http05.png "HTTP 请求报文")
<br/>

- HTTP **响应报文**的格式：
    - 与请求报文相比，响应报文只有第一行【**状态行**】不同，其他行类似：
    - ![http06.png](/images/net/http06.png "HTTP 响应报文格式")
- 状态行中的 状态码 共分五大类 33 种：
    - 常见的**状态码**如下：
        - ![http06-1png](/images/net/http06-1.png "HTTP 响应报文常见的状态码")
    - 常见的**状态行**如下：
        - ![http07.png](/images/net/http07.png "HTTP 响应报文常见的状态行")
- 一般来说，浏览器不会直接显示出服务器发来的状态行信息，而是以更友好的形式向用户告知服务器所返回的状态信息，例如 状态码404：
    - ![http08.png](/images/net/http08.png "HTTP 响应报文状态码404")

最后总结一下 HTTP 的报文格式 ：
- ![http08-1.png](/images/net/http08-1.png "HTTP 的报文格式")

<br/>

#### Cookie ：让服务器记住用户

浏览器通常会使用 Cookie 在服务器上**记录用户信息**
- 早期的万维网应用非常简单，仅是用户查看存放在不同服务器上的各种**静态**文档。因此 HTTP 被设计为一种 **无状态** 的协议，这样可以简化服务器的设计。
- 现在，可以通过万维网进行各种复杂的应用，如购物，电子商务等，这些应用需要万维网服务器能够**识别用户**；
    - 比如各种网站上的 **记住用户名，记住密码** 操作；
<br/>

- **Cookie** 提供了一种机制使得万维网服务器能够 **记住** 用户，而无需用户主动提供用户标识信息。也就是说：**Cookie 是 一种对 无状态的 HTTP 进行状态化的技术**。

首先，用户和服务器进行 TCP 连接，当用户的浏览器进程初次向服务器进程发送 HTTP 请求报文时：服务器进程**为该用户生成一个唯一的 Cookie 识别码**，并以此为索引在服务器的**后端数据库中创建一个项目**，用来记录该用户访问该网站的各种信息。（图中① ②）
- ![http09.png](/images/net/http09.png "Cookie 识别码")

接着再给浏览器进程发回 HTTP 响应报文，在报文中包含一个首部字段为 **Set-Cookie** 的首部行，该字段的取值就是 Cookie 识别码。当浏览器进程收到该响应报文后，就在一个特定的 Cookie 文件中添加一行，记录该服务器的 域名 和 Cookie 识别码。（图中 ③ ④）
- ![http10.png](/images/net/http10.png "Cookie 识别码")

用户再次使用该浏览器访问这个网站时，每发送一个 HTTP 请求报文，浏览器都会从 Cookie 文件中取出该网站的 Cookie 识别码，放到 HTTP 请求中发给服务器。服务器根据 Cookie 识别码 就可以识别出该用户，并返回该用户的个性化网页。
- ![http11.png](/images/net/http11.png "Cookie 识别码")

总之，主机端存 Cookie 识别码，服务器端存用户个性化网页信息；

<br/>

#### Web 缓存 与 代理服务器

万维网中还可以使用 缓存机制 以提高万维网的效率，它可位于客户机，也可位于中间系统上。

- 位于**客户机**，为 万维网缓存，又称 **Web 缓存（Web Cache）**；
- 位于**中间系统**上的 Web 缓存又称为 **代理服务器（Proxy Server）**。

Web 缓存 把最近的一些 请求和响应 暂存在本地磁盘中。**当新请求到达时，若新请求和暂存的请求相同，就返回暂存的响应，而不需要按 URL 的地址再次去因特网访问该资源**。

如图，主机要访问原始服务器，首先向校园网中的代理服务器发送请求：
- 若代理服务器中 **存放有所请求的对象**，则代理服务器给主机返回响应；
    - ![http12.png](/images/net/http12.png "Web 缓存1")
- 若代理服务器中 **没有所请求的对象**，则代理服务器先向原始服务器发送请求：
    - 原始服务器将 主机请求的对象 发给代理服务器；
    - 代理服务器将该响应 存入 **Web 缓存**；
    - 然后给主机 发回该响应；
    - ![http13.png](/images/net/http13.png "Web 缓存2")
- 如果 Web 缓存的命中率比较高，则大大减少了R1—R2链路上的通信量，减少了局域网中各主机访问因特网的时延。

【问题】假设原始服务器中的文档已被更改了呢？这样是不是主机请求到的文档与原始服务器中的文档就不一致了？
- ![http14.png](/images/net/http14.png "Web 缓存2")

—— 实际上，原始服务器通常会为每个响应的对象设定一个 **修改时间字段 和 有效时间字段**。当某台主机要请求原始服务器中的该文档时，首先向代理服务器发送请求，代理服务器先查看这两个字段：

- 若代理的该文档**未过期**，则代理服务器封装在报文，给主机发回；
<br/>

- 若代理的该文档**已过期**，则代理服务器会向原始服务器发送请求：
    - 请求报文中有首部字段为 **If-modified-since** 的首部行，表示该文档的**修改日期**；
    - 原始服务器根据修改日期判断代理的文档是否一致；
        - 若一致，则给代理服务器发送 不含实体主体 的响应，状态码 304，短语 Not Modified （表示 我没改），代理服务器更新 **有效日期字段**，并封装在响应报文发给主机；
            - ![http16.png](/images/net/http16.png "代理服务器更新文档")
        - 若不一致，则给代理发回 封装有文档的响应报文，这样代理服务器就更新了文档，并封装在响应报文发给主机；
            - ![http15.png](/images/net/http15.png "代理服务器更新文档")
 
最后，一个小例子加深 HTTP 连接方式，注意是先返回 html 文件，后返回引用的 jpeg。
- ![http17.png](/images/net/http17.png "小例子")

---------------