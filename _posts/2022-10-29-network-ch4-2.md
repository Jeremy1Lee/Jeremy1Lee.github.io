---
layout: post
title: "计网 Ch4：网络层-2"
author: LJC
tags:
- network
date: 2022-10-29 20:21 +0800
toc: true
---

# 网络层 (Network layer) - Part2

## 6. 路由选择协议 (Routing Protocol)

继续讨论该选择哪个路由的问题，**路由选择协议**可分为：
- 静态路由选择：采用人工配置的方式给路由器添加 [网络路由，默认路由，特定主机路由，黑洞路由](https://jeremy1lee.github.io/2022/10/27/network-ch4-1/#5-%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E4%BA%BA%E5%B7%A5%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%85%B6%E8%B7%AF%E7%94%B1%E9%97%AE%E9%A2%98) 等路由信息；

    - 简单，开销小，但**不能适应网络变化（流量，拓扑）**
    - **小规模网络**采用

- 动态路由选择：路由器通过路由选择协议 **自动获取路由信息**；
    
    - 复杂，开销大
    - 能**较好地适应网络状态变化**
    - 适用于**大规模网络**

无论什么协议，**路由选择协议都是在路由器上运行的**。

## - 6.1 路由选择协议概述

因特网作为最大的互联网，其采用的路由选择协议具有 **分布式，自适应，分层次**的特点。
- 自适应：动态路由选择，较好地适应网络状态变化；
- 分布式：**各路由器**信息交互，**共同完成** <u>路由信息获取和更新</u>；
- 分层次：整个因特网分成较小的**自治系统** AS (Autonomous System)，例如一个 ISP 。并在 AS 内外采用不同的路由选择协议分别进行路由选择。

既然是是分层次，那么对于两个自治系统：
- 自治系统**之间**的路由选择：**域间路由选择**

    - 外部网关协议 EGP ，或称 外部路由协议 ERP （指一类协议，不是具体一个协议）
        - 内部用什么 EGP 和其他系统用什么无关

- 自治系统**内部**的路由选择：**域内路由选择**：
    - 内部网关协 IGP ，或称 内部路由协议 IRP （指一类协议，不是具体一个协议）

![rp01.png](/images/net/rp01.png "AS")

常见的路由选择协议：

- **IGP** /内部：
    - RIP（最早）【距离向量】
    - IGRP（被EIGRP取代）【距离向量】
    - EIGRP 【混合】
    - OSPF（广泛使用在各种网络）【链路状态】
    - IS-IS（ISP骨干网上用的）【链路状态】
- EGP
    - BGP

![rp02.png](/images/net/rp02.png "AS")

### 路由器的基本结构

路由器是一种**具有多个输入端口和多个输出端口的专用计算机**。其任务是转发分组。结构按功能可划分为两大部分：

![router02.png](/images/net/router02.png "路由器")

1. 路由选择：核心是路由选择处理机，它根据所使用的路由选择协议周期性**与其他路由器**进行**路由信息交互**，来**更新路由表**，此外还要周期性给其他路由器发送自己所知道的路由信息。（这要通过下面的结构实现）
2. 分组转发：三部分：交换结构，一组输入，一组输出
- 比特流→帧→分组（网络层），看【分组类型】是什么，如果是：
    - 待转发的**数据分组**：根据目的地址查表转发，找不到就丢弃；否则，按匹配条目指示的端口转发，并更新一些字段的值（比如生存字段 -1）；
    - 路由器之间交换路由信息的**路由报文**：送交上面的路由选择处理机，用它更新**路由表**；
    - 注意这里 **路由表和转发表** 的差异：路由表路线最优，转发表查找最优：
        - ![router04.png](/images/net/router04.png "路由表和转发表")
- 数据链路层封装成帧→比特流→电信号发送；

3. 另外，路由器的各端口还应具有：
- **输入缓冲区**：暂存新进入路由器但来不及处理的分组；
- **输出缓冲区**：暂存处理完毕，但还来不及发送的分组；

图示如下：注意**一个端口即可输入也可输出**，图只是为了清楚理解流程。
![router03.png](/images/net/router03.png "路由器的结构")

--------------------
## - 6.2 路由信息协议 RIP 的基本工作原理

**路由信息协议 RIP** (Routing Information Protocol) 是内部网关协议 IGP 中**最先**得到广泛使用的协议之一。

- RIP 要求自治系统 AS 内的每一个路由都要维护从它自己到 AS 内其他每一个网络的距离记录，这时一组距离，称为 **距离向量 D-V (DIstance-Vector)**。
- ![rip01.png](/images/net/rip01.png "rip协议")
- RIP 使用 **跳数（Hop Count）**作为度量（Metric）来**衡量到达目的网络的距离**。
    - 路由器**到直连网络**的距离定义为 **1**；
    - 路由器**到非直连网络**的距离定义为 **所经过的路由器数 + 1**（两段：到直连，直连）；
    - 允许一条路径最多包含 15 个路由器，即 **距离为16时相当于不可达**；
    - **RIP 因此只适用于小型互联网**

（一） RIP 认为的好与坏：

1. RIP 认为 **好的路由就是距离短的路由**，也就是**通过路由器数量最少的路由**；
    - ![rip02.png](/images/net/rip02.png "rip协议认为好的路由")

2. 当到达同一目的网络有**多条距离相等的路由**时，RIP 可以进行**等价负载均衡**，即将通信量均衡地分布到多条等价的路由上
    - ![rip03.png](/images/net/rip03.png "rip协议")

3. RIP 包含以下三个要点：
    - **和谁交换信息？**——只和**相邻路由器**交换信息，如下图的 R1 和 R2 中间没有其他路由器，是相邻的；R1 和 R3 之间还存在其他路由器，不是相邻的。
        - ![rip04.png](/images/net/rip04.png "rip协议")

    - **交换什么信息？**——路由器自己的**路由表**；

    - **何时交换信息？**——**周期性交换**，例如每 30s 发一次rip更新报文

----------------

### RIP 的工作过程

（二） RIP 的基本工作过程

1. 路由器**刚开始工作时，只知道自己到直连网络的距离为1**，如图的条目都是到各自直连网的信息，距离都是1；
    - ![rip05.png](/images/net/rip05.png "rip开始")
2. 每个路由器**只和相邻路由器周期性地交换并更新路由信息**，如 R1/R2，R1/R3，R2/R3
3. 若干次交换和更新后，**每个路由器都知道到达本 AS 内各网络的最短距离和下一跳地址**，称为收敛。（可理解为一种完成初始化的操作）
    - ![rip06.png](/images/net/rip06.png "rip收敛")

（三） RIP 的路由条目更新规则

- C D 互为相邻路由器，它们周期性交换并更新路由信息。当C 该发送时，把自己的路由表信息封装到 RIP 更新报文发给 D 。（可以认为C把自己的路由表发给了D）
- D收到后对其改造
    - 将到达 C 的表的下一跳都改成 C ；
    - 距离都加 1 ；
    - 因为：C 告知 D它可以到达这些网络，途径是经过C，因此到这些网络的下一跳是C，而距离是C到它们的距离+1；
    - ![rip07.png](/images/net/rip07.png "如何改造")
- D 根据改造好的路由表更新自己先前的路由表，更新原则有：
    - ① 到达原有网络，且有**相同下一跳**的，有最新的消息，应该更新；【说明网络拓扑变化了】，如原来 D从C再到E 的距离是5，新消息表明 C到E 变为1，那么最新 D从C到E 的距离更新成 2；
    - ② 发现新的网络，添加；
    - ③ 到达目的网络，且**不同的**下一跳，新路由路线更优，更新；
    - ④ 到达目的网络，且**不同的**下一跳，新老路由路线相等，进行等价负载均衡；
    - 【不更新】：到达目的网络，**不同的**下一跳，新路由路线更差；
    - 【注意】：**大于15不可达**！
    - ![rip08.png](/images/net/rip08.png "各种情况")

### RIP 存在的问题

（四）RIP 存在 **坏消息传播得慢/路由环路/距离无穷计数**问题

出现了故障，R1把到达 N1 的距离改成16，表示 N1 不再可达，等RIP更新周期到时后发送该信息给R2。但此时R2的表中关于N1的信息仍然是此前获取到的，如图。

![rip10.png](/images/net/rip10.png "坏消息")

假设： R2 先到更新时间，即R2的信息先到达 R1，R1的坏消息后到达R2。

![rip09.png](/images/net/rip09.png "坏消息")

此时R1会被这条信息误导【旧的N1=16被覆盖掉了】，认为可以通过 R2 到达 N1 ，距离为3 。并等待发给 R2 。 R2 收到 R1 的"谣言"后，也被误导，认为可以通过 R1 到达 N1，距离为 4 ，并准备发给 R1.......以此循环往复，直到二者的路由表中到 N1 的距离**都达到 16** 时才收敛，

![rip11.png](/images/net/rip11.png "坏消息")

在此过程中，R1/R2 出现了路由环路，时间长达数分钟，这是**距离向量算法的一个固有问题**。可以采取多种措施**减少**出现该问题的概率或减小该问题带来的危害。但是并**不能彻底避免**路由环路问题，这是**距离向量算法**的本质导致的。
- 限制最大距离为 15
- 路由表一有变化，就**立即发送**更新报文（即 **触发更新**），而不仅是周期性发送；
- 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口反方向发送（即 **水平分割**）

注意，这里只介绍了 RIP 最基本的工作原理，并不是全部细节，如 RIP 有关报文的格式，定时时长等。基于 IPv4 的 RIP 有两个版本，还有基于 IPv6 的 RIPng 等。

-------------
## - 6.3 开放最短路径优先 OSPF （基于 Dijkstra 算法）

**开放最短路径优先 OSPF**(Open Shortest Path First) 是为客服 RIP 协议的缺点在1989年开发的；
- 开放： 表示 OSPF 是公开发表的；
- 最短路径优先： 是因为使用了 迪杰斯特拉提出的**最短路径**算法算法 SPF

OSPF 采用最短路径优先算法计算路由，从算法上保证了**不会产生路由环路**。同时**不限制网络规模，更新效率高，收敛速度快**。

（1）链路状态的获取，存储

注意，OSPF 是**基于链路状态**的，不像 RIP 是基于距离向量的；
- **链路状态**是指：1）本路由器都**和哪些路由器相邻**，2）相应 **链路的代价 (cost)**；
    - 代价 cost 用来表示费用，距离，时延，带宽等，都由网络管理人员来决定，例如下图：
        - ![ospf01.png](/images/net/ospf01.png "代价")

- OSPF 相邻路由器之间交互**问候（Hello）分组**，建立和维护**邻居关系**，如下图：
    - ![ospf01-1.png](/images/net/ospf01-1.png "场景图")

    - **问候（Hello）分组** <u>封装在 IP 数据报中</u>，发往组播地址 224.0.0.5 ；
        - ![ospf02.png](/images/net/ospf02.png "数据报结构")
        - Hello 分组 发送周期为 10秒 ；

    - 若 40s 未收到邻居的 Hello 分组，则认为该邻居路由器不可达。为此每个路由器都建立一个**邻居表**，记录其各邻居路由器的相关信息；
        - ![ospf03.png](/images/net/ospf03.png "邻居表")

（2）链路状态向外通告

- 使用 OSPF 的每个路由器都会产生 **链路状态通告 LSA** (Link State Advertisement)。LSA 中包含以下内容：
    - **直连网络** 的链路状态信息
    - **相邻路由器** 的链路状态信息
        - ![ospf04.png](/images/net/ospf04.png "链路状态通告")
    
-  LSA 被封装在 **链路状态更新分组 LSU** 中，采用**洪泛法**发送。收到链路状态更新分组的路由器将从自己其他所有接口转发该分组（也是洪泛转发）
    - 这样每个路由器发的链路状态都能传给其他所有路由器。

- 使用 OSPF 的每个路由器都有一个**链路状态数据库 LSDB**，用于存储 LSA 。

- 通过各路由器洪泛发送封装有自己 LSA 的 LSU 分组，各路由器的 LSDB 将达到一致，下图看 LSA/LSU/LSDB 的关系：
    - ![ospf05.png](/images/net/ospf05.png "LSxx 的关系")

（3）应用链路状态，计算最短路径

使用 OSPF 的各路由器 **基于 LSDB 进行最短路径优先 SPF 计算**，构建出各自到达其他路由器的最短路径，即构建各自的路由表。如图，**边的数值表示代价（权值）**。

![ospf06.png](/images/net/ospf06.png "OSPF的场景")

通过洪泛发送，所有路由器都会统一得到**相同的链路状态数据库**，得到带权有向图，应用 [迪杰斯特拉算法](https://jeremy1lee.github.io/2022/10/15/ten-algorithms-2/#%E5%85%AB%E8%BF%AA%E6%9D%B0%E6%96%AF%E7%89%B9%E6%8B%89-dijkstra-%E7%AE%97%E6%B3%95---%E6%9F%90%E4%B8%80%E8%B5%B7%E7%82%B9%E7%9A%84%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84) ，即**最短路径优先算法**，得出【以本路由器为起点，其他各路由器为终点】的最短路径。 

![ospf07.png](/images/net/ospf07.png "OSPF的场景")

（4）OSPF 的分组细节和应用分组的工作过程：

- OSPF 有以下五种分组类型：

    - ![ospf08.png](/images/net/ospf08.png "OSPF的分组")

- 以两个相邻路由器为例，OSPF的工作过程如下：

    - ![ospf09.png](/images/net/ospf09.png "OSPF的工作过程")

（5）OSPF 减少组播，提高效率的机制

看这种情况，路由器两两为邻居，每次要发n-1个Hello分组和状态更新分组。

![ospf10.png](/images/net/ospf10.png "OSPF的特殊情况")

为了减少发送分组数，OSPF 采用 **选举指定路由器 DR** (Designated Router) 和 **备用指定路由器 BDR** (Backup Designated Router) ，如下图左：

![ospf11.png](/images/net/ospf11.png "DR")

现在，所有的 **非 DR / 非 BDR** 只和 **DR/BDR** 建立关系，如上图右，邻居关系数量降低。
- 非 DR / 非 BDR 的路由器 （没title的）之间不能直接交换关系，必须通过 DR/BDR 进行交换；
- DR 出问题由 BDR 顶替；
- 选举 DR/BDR 也不复杂，只要交换一些参数如优先级，ID，接口IP等，根据选举规则选【与 STP 协议选举根交换机类似】

（6）在**大规模**网络应用 OSPF 的机制

同样是为了减少洪泛，划分子区域，设定如下：

![ospf12.png](/images/net/ospf12.png "大规模网络应用 OSPF")

OSPF 把一个 AS 再分成 **区域 Area**，用区域标识符表示（32bit 十进制点分，类似Ipv4），主干区域必须是【0.0.0.0】，**目的是减少每个区域内部交换路由信息的洪泛通信量**。

![ospf13.png](/images/net/ospf13.png "很大规模网络应用 OSPF的机制")





