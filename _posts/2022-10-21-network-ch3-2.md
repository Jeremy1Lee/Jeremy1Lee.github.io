---
layout: post
title: "计网 Ch3：数据链路层-2"
author: LJC
tags:
- network
date: 2022-10-24 13:50 +0800
toc: true
---

# 数据链路层 (Data link layer)-2

## 7. MAC 地址，IP 地址， ARP 协议

日常的网络应用离不开这些地址；

- MAC 地址【数据链路层】：以太网的 MAC 子层使用的地址；
- IP 地址【网际层】： TCP/IP 体系结构网际层所使用的地址；
- ARP协议【网际层】：属于 TCP/IP 的网际层。作用是已知设备分配到的 IP 地址，通过该 IP 地址获取该设备的 MAC 地址；

![mac-ip01.png](/images/net/mac-ip01.png "MAC 地址，IP 地址， ARP 协议")

- 点对点（1对1）的数据链路层不需要地址。当多个主机连在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都得有一个数据链路层地址。

![macip02.png](/images/net/macip02.png "MAC 地址")

### **7.1 MAC 地址（硬件地址/ 物理地址）**

####    - 7.1.1 MAC 地址的概念

1. 每个主机发送的帧中必须携带标识 **发送主机和接收主机** 的地址，这类地址**用于媒体接入控制** MAC，所以叫MAC地址；
    - MAC地址一般**固化**在网卡（网络适配器）的电可擦可编程只读存储器 EEPROM 中，生产时写在设备内部，因此 **MAC 地址也被称为硬件地址**。
    - 但这**并不表示 MAC 地址属于物理层**！
    ![macip03.png](/images/net/macip03.png "网卡")

2. 用户主机一般含有两个网络适配器：有线局域网适配器（**有线**网卡）和无线局域网适配器（**无线**网卡）。每个网络适配器都有一个全球唯一的 MAC 地址。交换器和路由器往往有更多的网络接口，也就有更多的 MAC 地址。所以，严格来说，**MAC 地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识**。

####    - 7.1.2 MAC 地址的表示方法：EUI-48

- IEEE 802局域网的MAC地址格式：由48个比特，6个字节构成。OUI 由设备厂商向机构申请分配，后三个厂商自行分配；

- **标准表示法：XX-XX-XX-XX-XX-XX**，其他表示法如图所示；

![macip04.png](/images/net/macip04.png "MAC")

- 地址中含有特殊含义的字段：**全球/本地管理，单播/多播**

![macip05.png](/images/net/macip05.png "全球/本地管理，单播/多播")

01——用于特定功能，例如交换机生成树协议所需要的多播地址；

####    - 7.1.3 MAC 地址的发送：单播与多播

- 发送顺序：

![macip06.png](/images/net/macip06.png "发送顺序")

- **单播帧，广播帧，多播帧**：
    - 单播和广播如图，目的主机查看帧的目的地址，和自己的MAC地址匹配，或者是广播FFFFF就接受该帧，否则丢弃；
    ![macip07.png](/images/net/macip07.png "单播帧，广播帧")
    - 如果是多播帧，如上述的 b0 = 1（显然为16进制的奇数），收到多播帧的主机查自己的多播组列表，判断是否接受该多播帧；
        - 快速判断多播帧的方法：
        ![macip08.png](/images/net/macip08.png "多播帧")
        - 当给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址；

- 随机 MAC 地址：连接并不显示设备的真实MAC地址，而是使用随机生成的 MAC 地址进行网络通信，而不是真实 MAC 地址；连接不同网络会生成不同的随机 MAC地址，从而可以避免因MAC地址被收集，泄漏个人隐私。
    - 诸如校园网使用 MAC 地址认证，之前绑定了真实的 MAC 地址，现在使用随机 MAC 地址认证，肯定会出现认证失败。必须使用匹配的 MAC 地址，才能认证成功。此时要么在认证服务器上绑定随机 MAC 地址，要么把终端的随机 MAC 地址功能关闭。

-----------------------
### **7.2 IP 地址（网络层）**

####    - 7.2.1 IP 地址的概念

IP 地址属于网络层，在这讲解只是因为 IP 地址和 MAC 地址之间存在一定关系，这里主要介绍其作用：

- IP 地址是因特网上的主机和路由器所使用的地址，用于标识两部分信息：
    - **网络编号**：因特网上百万计的网络，如 **192.168.0**.xxx【ipv4前三位】
    - **主机编号**：同一网络上不同主机或路由器各接口，如 192.168.0.**254**【ipv4最后一位】
- 显然 MAC 地址不具备**区分不同网络**的功能，而 IP 地址具备。
    - 如果只是一个单独的网络，可以只使用 MAC 地址；
    - 如果要接入互联网，则 MAC 和 IP 都要使用；
    - 其实这也是数据链路层和网络层的差异：数据链路层解决分组在一个网络上传播的问题，网络层解决分组在多个网络上传播的问题；
![macip09.png](/images/net/macip09.png "IP 地址与MAC地址")

####    - 7.2.2 数据转发：IP不变MAC变

数据链路层解决分组在**一个网络**上传播的问题，网络层解决分组在**多个网络**上传播的问题。
如图，显然H1和H2属于不同的网络，观察转发过程中ip地址与mac地址是如何封装的：

![macip10.png](/images/net/macip10.png "数据转发过程")

- 从H1传数据到H2，H1 知道应该先传给 R1 
- H1 到 R1 ：封装帧填 MAC 地址时，应该局限在这一个网络里，即源和目的MAC地址分别填MAC1和**MAC3**（非MAC2，因为它并不知道R1的**MAC地址**是什么，所以要填入R1的MAC地址，让他转发到R1）
- 到下一个网络又只能填 MAC4 和 MAC5 ；
- （后续网络层讲解）主机知道其他主机的 IP 地址，但不知道 MAC 地址，这用到了 ARP 协议；
- 而IP地址则永远是 IP1到IP2 ；

**总结：数据包的转发过程中：**
- 源IP地址和目的IP地址始终保持不变；
- 而源MAC地址和目的MAC地址随网络变化而变化；

-----------------
### **7.3 ARP 协议**

####    - 7.3.1 ARP 协议流程

- 如图，B 知道 C 的 IP 地址，但不知道 C 的 MAC地址，这样在链路层封装 MAC 帧时无法填写目的 MAC 地址。
![arp00.png](/images/net/arp00.png "arp")

- B 给 C 发数据包时，首先在 ARP 高速缓存表中查找 C 的 IP 地址所对应的 MAC 地址。比如这里就存了之前获取到的 A 的 ip 与 MAC 的对应关系；

![arp01.png](/images/net/arp01.png "arp01")

- 如果没找到， B 会发送一个 **ARP 请求报文**（以**广播**形式），以 C 的 IP 地址查找 C 的 MAC 地址。ARP 请求报文封装在 MAC 帧中（目的地址是FFFFF），其他主机都能收到该帧；

![arp02.png](/images/net/arp02.png "arp02")

- 主机 A 收到 ARP 请求报文，交付上层处理，发现问的**ip地址**不是自己，不予理会；
- 主机 C 收到 ARP 请求报文，交付上层处理，问的**ip地址**是自己，需要响应
    - 先在自己的ARP缓存中记录下 B 的 ip-mac地址；
    - 给 B 发 ARP 响应报文；
    - 依然是封装在 MAC 帧中；

![arp03.png](/images/net/arp03.png "arp03")

- 由于是总线，其他主机都能收到，A发现MAC地址不匹配，网卡直接丢弃该帧；B 则交付上层，解析ARP响应报文，记录到 ARP 高速缓存表中，就根据 C 的IP得到了 C 的MAC，可以传输信息了；

![arp04.png](/images/net/arp04.png "arp04")

####    - 7.3.2 ARP 缓存表

ARP 缓存表里的item有**静态和动态**两种；动态会删除，因为 IP 地址与 MAC 地址的对应并不是永久性的，如当主机更换新网卡后 IP 没变， MAC 变了；

![arp05.png](/images/net/arp05.png "arp05")
![arp05.png](/images/net/arp05.png=200x)
![arp05.png](/images/net/arp05.png =200x)


####    - 7.3.3 ARP 协议的注意事项

- 注意，**ARP 的使用是逐链路进行的**，**不能跨链路使用**（因为基于广播，而广播是MAC地址为FFFFF，受MAC地址影响，不能跨网络）；
- 存在 **ARP 欺骗攻击问题**-网安；

--------------------