---
layout: post
title: "计网 Ch3：数据链路层-2"
author: LJC
tags:
- network
date: 2022-10-24 13:50 +0800
toc: true
---

# 数据链路层 (Data link layer)-2

## 7. MAC 地址，IP 地址， ARP 协议

日常的网络应用离不开这些地址；

- MAC 地址【数据链路层】：以太网的 MAC 子层使用的地址；
- IP 地址【网际层】： TCP/IP 体系结构网际层所使用的地址；
- ARP协议【网际层】：属于 TCP/IP 的网际层。作用是已知设备分配到的 IP 地址，通过该 IP 地址获取该设备的 MAC 地址；

![mac-ip01.png](/images/net/mac-ip01.png "MAC 地址，IP 地址， ARP 协议")

- 点对点（1对1）的数据链路层不需要地址。当多个主机连在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都得有一个数据链路层地址。

![macip02.png](/images/net/macip02.png "MAC 地址")

### **7.1 MAC 地址（硬件地址/ 物理地址）**

####    - 7.1.1 MAC 地址的概念

1. 每个主机发送的帧中必须携带标识 **发送主机和接收主机** 的地址，这类地址**用于媒体接入控制** MAC，所以叫MAC地址；
    - MAC地址一般**固化**在网卡（网络适配器）的电可擦可编程只读存储器 EEPROM 中，生产时写在设备内部，因此 **MAC 地址也被称为硬件地址**。
    - 但这**并不表示 MAC 地址属于物理层**！
    ![macip03.png](/images/net/macip03.png "网卡")

2. 用户主机一般含有两个网络适配器：有线局域网适配器（**有线**网卡）和无线局域网适配器（**无线**网卡）。每个网络适配器都有一个全球唯一的 MAC 地址。交换器和路由器往往有更多的网络接口，也就有更多的 MAC 地址。所以，严格来说，**MAC 地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识**。

####    - 7.1.2 MAC 地址的表示方法：EUI-48

- IEEE 802局域网的MAC地址格式：由48个比特，6个字节构成。OUI 由设备厂商向机构申请分配，后三个厂商自行分配；

- **标准表示法：XX-XX-XX-XX-XX-XX**，其他表示法如图所示；

![macip04.png](/images/net/macip04.png "MAC")

- 地址中含有特殊含义的字段：**全球/本地管理，单播/多播**

![macip05.png](/images/net/macip05.png "全球/本地管理，单播/多播")

01——用于特定功能，例如交换机生成树协议所需要的多播地址；

####    - 7.1.3 MAC 地址的发送：单播与多播

- 发送顺序：

![macip06.png](/images/net/macip06.png "发送顺序")

- **单播帧，广播帧，多播帧**：
    - 单播和广播如图，目的主机查看帧的目的地址，和自己的MAC地址匹配，或者是广播FFFFF就接受该帧，否则丢弃；
    ![macip07.png](/images/net/macip07.png "单播帧，广播帧")
    - 如果是多播帧，如上述的 b0 = 1（显然为16进制的奇数），收到多播帧的主机查自己的多播组列表，判断是否接受该多播帧；
        - 快速判断多播帧的方法：
        ![macip08.png](/images/net/macip08.png "多播帧")
        - 当给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址；

- 随机 MAC 地址：连接并不显示设备的真实MAC地址，而是使用随机生成的 MAC 地址进行网络通信，而不是真实 MAC 地址；连接不同网络会生成不同的随机 MAC地址，从而可以避免因MAC地址被收集，泄漏个人隐私。
    - 诸如校园网使用 MAC 地址认证，之前绑定了真实的 MAC 地址，现在使用随机 MAC 地址认证，肯定会出现认证失败。必须使用匹配的 MAC 地址，才能认证成功。此时要么在认证服务器上绑定随机 MAC 地址，要么把终端的随机 MAC 地址功能关闭。

-----------------------
### **7.2 IP 地址（网络层）**

####    - 7.2.1 IP 地址的概念

IP 地址属于网络层，在这讲解只是因为 IP 地址和 MAC 地址之间存在一定关系，这里主要介绍其作用：

- IP 地址是因特网上的主机和路由器所使用的地址，用于标识两部分信息：
    - **网络编号**：因特网上百万计的网络，如 **192.168.0**.xxx【ipv4前三位】
    - **主机编号**：同一网络上不同主机或路由器各接口，如 192.168.0.**254**【ipv4最后一位】
- 显然 MAC 地址不具备**区分不同网络**的功能，而 IP 地址具备。
    - 如果只是一个单独的网络，可以只使用 MAC 地址；
    - 如果要接入互联网，则 MAC 和 IP 都要使用；
    - 其实这也是数据链路层和网络层的差异：数据链路层解决分组在一个网络上传播的问题，网络层解决分组在多个网络上传播的问题；
![macip09.png](/images/net/macip09.png "IP 地址与MAC地址")

####    - 7.2.2 数据转发：IP不变MAC变

数据链路层解决分组在**一个网络**上传播的问题，网络层解决分组在**多个网络**上传播的问题。
如图，显然H1和H2属于不同的网络，观察转发过程中ip地址与mac地址是如何封装的：

![macip10.png](/images/net/macip10.png "数据转发过程")

- 从H1传数据到H2，H1 知道应该先传给 R1 
- H1 到 R1 ：封装帧填 MAC 地址时，应该局限在这一个网络里，即源和目的MAC地址分别填MAC1和**MAC3**（非MAC2，因为它并不知道R1的**MAC地址**是什么，所以要填入R1的MAC地址，让他转发到R1）
- 到下一个网络又只能填 MAC4 和 MAC5 ；
- （后续网络层讲解）主机知道其他主机的 IP 地址，但不知道 MAC 地址，这用到了 ARP 协议；
- 而IP地址则永远是 IP1到IP2 ；

**总结：数据包的转发过程中：**
- 源IP地址和目的IP地址始终保持不变；
- 而源MAC地址和目的MAC地址随网络变化而变化；

-----------------
### **7.3 ARP 协议**

####    - 7.3.1 ARP 协议流程

- 如图，B 知道 C 的 IP 地址，但不知道 C 的 MAC地址，这样在链路层封装 MAC 帧时无法填写目的 MAC 地址。
![arp00.png](/images/net/arp00.png "arp")

- B 给 C 发数据包时，首先在 ARP 高速缓存表中查找 C 的 IP 地址所对应的 MAC 地址。比如这里就存了之前获取到的 A 的 ip 与 MAC 的对应关系；

![arp01.png](/images/net/arp01.png "arp01")

- 如果没找到， B 会发送一个 **ARP 请求报文**（以**广播**形式），以 C 的 IP 地址查找 C 的 MAC 地址。ARP 请求报文封装在 MAC 帧中（目的地址是FFFFF），其他主机都能收到该帧；

![arp02.png](/images/net/arp02.png "arp02")

- 主机 A 收到 ARP 请求报文，交付上层处理，发现问的**ip地址**不是自己，不予理会；
- 主机 C 收到 ARP 请求报文，交付上层处理，问的**ip地址**是自己，需要响应
    - 先在自己的ARP缓存中记录下 B 的 ip-mac地址；
    - 给 B 发 ARP 响应报文；
    - 依然是封装在 MAC 帧中；

![arp03.png](/images/net/arp03.png "arp03")

- 由于是总线，其他主机都能收到，A发现MAC地址不匹配，网卡直接丢弃该帧；B 则交付上层，解析ARP响应报文，记录到 ARP 高速缓存表中，就根据 C 的IP得到了 C 的MAC，可以传输信息了；

![arp04.png](/images/net/arp04.png "arp04")

####    - 7.3.2 ARP 缓存表

ARP 缓存表里的item有**静态和动态**两种；动态会删除，因为 IP 地址与 MAC 地址的对应并不是永久性的，如当主机更换新网卡后 IP 没变， MAC 变了；

![arp05.png](/images/net/arp05.png "arp05")

####    - 7.3.3 ARP 协议的注意事项

- 注意，**ARP 的使用是逐链路进行的**，**不能跨链路使用**（因为基于广播，而广播是MAC地址为FFFFF，受MAC地址影响，不能跨网络）；
- 存在 **ARP 欺骗攻击问题**-网安；

--------------------

## 8. 集线器 (Hub) 与交换机 (Switch) 的区别

### **8.1 集线器（总线网，物理层）**

集线器(有源)，使用大规模集成电路，可靠性非常高。配合双绞线，取代了同轴电缆总线，但现在也被交换机淘汰；
- **使用集线器的以太网在逻辑上还是一个总线网**，各站共享总线资源，使用的还是 **CSMA/CD 协议**；
- **集线器只工作在物理层**，每个接口仅简单地转发比特，不进行比特检测（这个活是网卡的）；【分析问题时，还是可以看成一个总线网络】
- **集线器一般都有少量的容错能力和网络管理功能**，比如某个网卡故障不停发送帧，集线器可以检测到，并断开与它的连线；

![macip11.png](/images/net/macip11.png "集线器")

使用集线器在物理层扩展以太网：
- 拓展前，各部分发送示意图：三个可能发生冲突的域
![hub01.png](/images/net/hub01.png "集线器扩展前")
- 再用一个集线器把这三个也连起来，形成更大的总线以太网，冲突域更大了；
![hub02.png](/images/net/hub02.png "集线器扩展后")
- 看图，现在1系中的主机给2系中的主机发信号，3系的也能收到，此前则收不到；

### **8.2 以太网交换机 (数据链路层) **

目前在以太网中使用最广泛的互连设备。是集线器之后发展出的更先进设备，性能远超集线器。先看区别：同样是发送单播帧，显然集线器的总线网所有主机都能收到，而交换机只转发给目的主机。

![swc01.png](/images/net/swc01.png "交换机")

1. 工作模式
- 集线器的总线网需要用 CSMA/CD 协议来协调各主机争用总线，只能半双工（收发帧不能同时进行）；
- 而交换机则工作在全双工模式；
2. 以太网交换机具有**并行性**，同时联通多对接口，使多对主机同时通信，**无碰撞（不使用 CSMA/CD 协议）**
3. 以太网交换机一般有多种速率接口，如10Mb/s，100Mb/s，1Gb/s等；
- ![swc02.png](/images/net/swc02.png "并行，多接口")

4. 以太网交换机工作在数据链路层（也包括物理层），收到帧后在**帧交换表**中**查找帧的目的 MAC 地址所对应的接口号**，然后**通过该接口转发帧**；
- ![swc03.png](/images/net/swc03.png "转发帧")

5. 以太网交换机即插即用，内部的**帧交换表**是<u>自学习算法自动逐渐建立的</u>；

6. 帧的两种转发方式：
- **存储转发**：把帧先缓存后再处理；
- **直通交换**：不缓存直接找端口转，采用基于硬件的交叉矩阵（交换时延小，但不检查帧的差错）；

### 8.3 对比

> 注：忽略 ARP 过程，且假设交换机的帧交换表已配置好；

- ![swc04.png](/images/net/swc04.png "对比")

1. 单台主机发帧（上图）
- 单播：
    - 集线器：都传，由网卡检测帧的目的MAC地址，决定是否接受；
    - 交换机：转发到目的地址端口；
- 广播 FF-FF-FF...：
    - 集线器：都传，由网卡检测帧的目的MAC地址，决定是否接受；
    - 交换机：转发到所有接口；
    - 广播帧效果一致，属于同一广播域
2. 多台主机发帧：（上图）
- 单播：
    - 集线器：碰撞，碰撞信息到达各主机，后面根据CSMA/CD
    - 交换机：缓存并逐个转发，无碰撞；
3. 两种方式扩展以太网，单播和广播（下图）
- 单播：
    - 集线器：都传，由网卡检测帧的目的MAC地址，决定是否接受；
    - 交换机：转发到目的地址端口；
- 广播：
    - 集线器：都传，由网卡检测帧的目的MAC地址，决定是否接受；
    - 交换机：转发到所有接口；
- ![swc06.png](/images/net/swc06.png "广/单播")

4. 两种扩展**广播域都变大**，各主机都属于同一个广播域
    - 集线器扩展，逻辑上共享总线，**碰撞域变大**（参与竞争的主机增加）
    - 交换机拓展 则不会扩大碰撞域；

- ![swc05.png](/images/net/swc05.png "广播域和碰撞域")

--------------------

## 9. 以太网交换机自学习和转发帧的流程

以太网交换机工作在**数据链路层**（包括物理层），收到帧后，查找帧交换表中目的MAC地址的接口号，然后通过该接口转发帧。
如图，两个互联的以太网交换机，各自连了三个主机，构成了交换式以太网，假设已知MAC地址。

A 给 B 发：
- 登记：记录帧的源MAC地址和这个**帧来自哪个接口号**
- 转发：查找 B 的MAC地址
    - 找不到 B 的MAC地址，开始**盲目转发（泛洪）**：除源接口外的所有接口都转发该帧；
- ![swc07.png](/images/net/swc07.png "盲目转发（泛洪）")
- B 接到帧，根据目的地址，接受帧。C 根据目的MAC丢弃帧
- 帧又进入交换机2，
    - sw2也先登记，但这次记录的是2（因为从2进来的帧）
    - 查不到目的MAC 地址 B ，开始盲目转发（泛洪），D E F 都收到但丢弃；
    - ![swc08.png](/images/net/swc08.png "交换机2")



## 8. MAC 

![]( "")

### **7.1 MAC 地址**

####    - 7.1.1 概念

