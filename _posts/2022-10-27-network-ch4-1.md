---
layout: post
title: "计网 Ch4：网络层-1"
author: LJC
tags:
- network
date: 2022-10-27 20:50 +0800
toc: true
---

# 网络层 (Data link layer)

## 1. 网络层概述

网络层的主要任务是**实现网络互连**，进而实现数据包在各网络之间的传输，如图，如果这些**异构型网络**（有线，无线，总线，共享，广域，局域 ......）实现内部通信，只需要实现物理层和数据链路层即可，但如果将异构型网络互连起来，形成一个更大的互联网，就需要使用网络层互连设备**路由器**。连接后这些网络可以只看成链路。

![web01.png](/images/net/web01.png "网络层")

要实现数据包传不同网络，就必须实现**网络层**，它需要解决以下**主要问题**：
- **网络层向运输层提供怎样的服务**（ **可靠传输 还是 不可靠传输** ）
    - 误码，被丢弃，乱序等传输错误，不采取措施为不可靠传输；
    - 不同网络体系结构提供服务可能不同
        - 因特网（TCP/IP）的网际层提供不可靠，无连接的数据报服务；
        - ATM，帧中继等的网络层提供面向连接的可靠虚电路服务；
- **网络层寻址问题**
    - TCP/IP 的网际层使用 IP 地址，不同网络的地址表达不同，如图：
    - ![web02.png](/images/net/web02.png "网络层")
- **路由选择问题**
    - 数据包从源站到目的站的路径选择
    - 如图，路由器把数据包转发到哪个接口？——路由表，如何得到；
    - ![web03.png](/images/net/web03.png "路由选择")

**因特网**（Internet）是目前全世界用户数量最多的互联网，它使用 TCP/IP 协议栈。TCP/IP 的网络层使用网际协议 IP 作为核心，因此在 TCP/IP 协议栈中网络层常称为**网际层**。

接下来将基于 **TCP/IP 协议的网际层**来学习网络层的理论知识和实践技术，网际层除了核心 IP 协议，还有地址解析协议 ARP ，ICMP 协议， IGMP 协议等；
![web04.png](/images/net/web04.png "TCP/IP 协议")

------------
## 2. 网络层提供的两种服务（面向连接 和 无连接）

### 2.1 面向**连接**的虚电路服务

虚电路服务的<mark>核心思想</mark>是：可靠通信**由网络自身**来保证；

- 两台计算机通信时，首先建立**网络层的连接** —— **虚电路 VC** (Virtual Circuit)，保证通信双方所需的一切网络资源；
- 通信**双方沿着已建立的虚电路发送分组**；
    - ![web05.png](/images/net/web05.png "虚电路 VC")
    - 虚电路表示这是一条逻辑上的连接，分组沿这条路径按 存储转发方式 发送，而不是真正的物理连接，所以是**虚**电路
- 完整的目的主机地址 仅在只在建立连接阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**（构成虚电路的每一段 <u>链路</u> 都有一个虚电路编号）
- 这种通信方式如果再使用上可靠传输的网络协议，就可使发送的分组最终**正确到达**接收方（无差错按序到达，不丢失不重复）；
- **通信结束后，需要释放之前所建立的虚电路**；

> 很多广域分组交换网都使用面向连接的虚电路服务，如曾经的X.25和ARM，FR等，不过**因特网并没有采用这种虚电路服务，而是数据报服务**

### 2.2 无连接的**数据报**服务

数据报服务的<mark>核心思想</mark>是：**可靠通信应当由用户主机来保证**，简单灵活，尽最大努力交付的数据报服务。

- 两台计算机通信时，**不需要建立网络层连接**
- 每个**分组可以走不同的路径**，因此**分组的首部必须携带目的主机的完整地址**
    - 所以这种方式所传送的分组可能误码，丢失，重复和失序等
    - ![web06.png](/images/net/web06.png "数据报服务")
- 由于**网络本身不提供端到端的可靠传输服务**，使网络中的路由器可以做的比较简单，成本低（相对交换机而言）
- 因特网采用此思想，**将复杂的网络处理功能置于因特网边缘（即用户主机和其内部的运输层）**，而将相对简单的尽最大努力的分组交付功能置于因特网核心，网络造价降低，简单灵活，应用多。

总结一下两种服务：
![web07.png](/images/net/web07.png "服务")

因特网的网际层提供尽最大努力交付的数据报服务，也是本章围绕的主题：网际层如何传送 IP 数据报（分配地址，路由机制，IP 协议等）

------------
## 3. **IPv4 地址**

### 3.1 IPv4 概述

【概念】：**IPv4 地址是给因特网上每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的 32 比特的标识符。**

**1.如何分配：**
IP 地址由 ICANN 机构统一分配，15年开始逐步用 IPv6 。IPv4 的编制方法经历了以下三个历史阶段：
![web08.png](/images/net/web08.png "IPv4 的编制方法")

**IPv4 的表示：**
32位的 IPv4 地址不方便阅读，记录，输入等，因此 IPv4 地址采用 **点分十进制表示方法** 以方便用户使用；

![ipv4-01.png](/images/net/ipv4-01.png "IPv4 的表示方法")

### 3.2  IPv4 分类编址：ABCDE

分类编址分五类：

![ipv4-02.png](/images/net/ipv4-02.png "IPv4 五类")

- 只有 ABC 类可分配给网络中的主机或路由器各接口；
- 对不同类网络，**网络号**有保留的也有不留的；
- 对所有五类网络而言，**主机号**都要掐头去尾：
    - **主机号 全0** 的地址是**网络地址**，不能分配给主机和路由器各接口；
    - **主机号 全1** 的地址是**广播地址**，不能分配给主机和路由器各接口；
- 根据地址的构造可以看出：
    - **A 类地址网络少，但主机多**
    - **B 类地址一半一半**
    - **C 类地址网络多，但主机少**

**（1）A类地址**

![ipv4-03.png](/images/net/ipv4-03.png "IPv4 -A")

一共 32 位，8位网络号【首部固定为 0】，24位主机号：
- 网络号
    - 最小（全0）：保留
    - 最大（全1）：本地环回测试，保留
- 主机号固定留着最小和最大
    - 最小（全0）：网络地址
    - 最大（全1）：广播地址

**（2）B类地址**

一共32位，16 位网络号【首部固定为 10】，16 位主机号：
![ipv4-04.png](/images/net/ipv4-04.png "IPv4 - B")

**（3）C类地址**
一共32位，24 位网络号【首部固定为 110】，8 位主机号：
![ipv4-05.png](/images/net/ipv4-05.png "IPv4 - C")

（4）根据 **X.Y.Z.W** 判断是哪类地址：

1. 判断网络类型
- **X < 127：A**
- **128 - 191：B**
- **192 - 223：C**

2. 得到网络号

- A类的网络号为X
- B类的网络号为XY
- C类的网络号为XYZ

3. 剩下的就是主机号了

4. 不能指派的地址：
- A 的**网络号**0和127
- **主机号**全0或全1

5. 特殊的地址：
- 0.0.0.0 ：表示 "在本网络上的本主机" ，只能作为源地址；
- 255.255.255.255：表示 "只在本网络上进行广播（路由器不转发）"，只能作为目的地址；

![ipv4-06.png](/images/net/ipv4-06.png "IPv4")