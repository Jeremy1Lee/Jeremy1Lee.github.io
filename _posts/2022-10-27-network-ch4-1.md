---
layout: post
title: "计网 Ch4：网络层-1"
author: LJC
tags:
- network
date: 2022-10-27 20:50 +0800
toc: true
---

# 网络层 (Data link layer)

## 1. 网络层概述

网络层的主要任务是**实现网络互连**，进而实现数据包在各网络之间的传输，如图，如果这些**异构型网络**（有线，无线，总线，共享，广域，局域 ......）实现内部通信，只需要实现物理层和数据链路层即可，但如果将异构型网络互连起来，形成一个更大的互联网，就需要使用网络层互连设备**路由器**。连接后这些网络可以只看成链路。
【注意】：网际层并不实现可靠传输，也就是不保证 IP 数据报不丢失；

![web01.png](/images/net/web01.png "网络层")

要实现数据包传不同网络，就必须实现**网络层**，它需要解决以下**主要问题**：
- **网络层向运输层提供怎样的服务**（ **可靠传输 还是 不可靠传输** ）
    - 误码，被丢弃，乱序等传输错误，不采取措施为不可靠传输；
    - 不同网络体系结构提供服务可能不同
        - 因特网（TCP/IP）的网际层提供不可靠，无连接的数据报服务；
        - ATM，帧中继等的网络层提供面向连接的可靠虚电路服务；
- **网络层寻址问题**
    - TCP/IP 的网际层使用 IP 地址，不同网络的地址表达不同，如图：
    - ![web02.png](/images/net/web02.png "网络层")
- **路由选择问题**
    - 数据包从源站到目的站的路径选择
    - 如图，路由器把数据包转发到哪个接口？——路由表，如何得到；
    - ![web03.png](/images/net/web03.png "路由选择")

**因特网**（Internet）是目前全世界用户数量最多的互联网，它使用 TCP/IP 协议栈。TCP/IP 的网络层使用网际协议 IP 作为核心，因此在 TCP/IP 协议栈中网络层常称为**网际层**。

接下来将基于 **TCP/IP 协议的网际层**来学习网络层的理论知识和实践技术，网际层除了核心 IP 协议，还有地址解析协议 ARP ，ICMP 协议， IGMP 协议等；
![web04.png](/images/net/web04.png "TCP/IP 协议")

------------
## 2. 网络层提供的两种服务（面向连接 和 无连接）

### 2.1 面向**连接**的虚电路服务

虚电路服务的<mark>核心思想</mark>是：可靠通信**由网络自身**来保证；

- 两台计算机通信时，首先建立**网络层的连接** —— **虚电路 VC** (Virtual Circuit)，保证通信双方所需的一切网络资源；
- 通信**双方沿着已建立的虚电路发送分组**；
    - ![web05.png](/images/net/web05.png "虚电路 VC")
    - 虚电路表示这是一条逻辑上的连接，分组沿这条路径按 存储转发方式 发送，而不是真正的物理连接，所以是**虚**电路
- 完整的目的主机地址 仅在只在建立连接阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**（构成虚电路的每一段 <u>链路</u> 都有一个虚电路编号）
- 这种通信方式如果再使用上可靠传输的网络协议，就可使发送的分组最终**正确到达**接收方（无差错按序到达，不丢失不重复）；
- **通信结束后，需要释放之前所建立的虚电路**；

> 很多广域分组交换网都使用面向连接的虚电路服务，如曾经的X.25和ARM，FR等，不过**因特网并没有采用这种虚电路服务，而是数据报服务**

### 2.2 无连接的**数据报**服务

数据报服务的<mark>核心思想</mark>是：**可靠通信应当由用户主机来保证**，简单灵活，尽最大努力交付的数据报服务。

- 两台计算机通信时，**不需要建立网络层连接**
- 每个**分组可以走不同的路径**，因此**分组的首部必须携带目的主机的完整地址**
    - 所以这种方式所传送的分组可能误码，丢失，重复和失序等
    - ![web06.png](/images/net/web06.png "数据报服务")
- 由于**网络本身不提供端到端的可靠传输服务**，使网络中的路由器可以做的比较简单，成本低（相对交换机而言）
- 因特网采用此思想，**将复杂的网络处理功能置于因特网边缘（即用户主机和其内部的运输层）**，而将相对简单的尽最大努力的分组交付功能置于因特网核心，网络造价降低，简单灵活，应用多。

总结一下两种服务：
![web07.png](/images/net/web07.png "服务")

因特网的网际层提供尽最大努力交付的数据报服务，也是本章围绕的主题：网际层如何传送 IP 数据报（分配地址，路由机制，IP 协议等）

------------
## 3. **IPv4 地址**

### 3.1 IPv4 概述

【概念】：**IPv4 地址是给因特网上每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的 32 比特的标识符。**

【作用/为什么要有ipv4】：异构网络的设备想互连，总要有地址来寻找各设备，两部分：网络，主机

**1.如何分配：**
IP 地址由 ICANN 机构统一分配，15年开始逐步用 IPv6 。IPv4 的编制方法经历了以下三个历史阶段：
![web08.png](/images/net/web08.png "IPv4 的编制方法")

**IPv4 的表示：**
32位的 IPv4 地址不方便阅读，记录，输入等，因此 IPv4 地址采用 **点分十进制表示方法** 以方便用户使用；

![ipv4-01.png](/images/net/ipv4-01.png "IPv4 的表示方法")

-------------
### 3.2  IPv4 的**分类编址**：ABCDE 五类

分类编址分五类：

![ipv4-02.png](/images/net/ipv4-02.png "IPv4 五类")

- 只有 ABC 类可分配给网络中的主机或路由器各接口；
- 对不同类网络，**网络号**有保留的也有不留的；
- 对所有五类网络而言，**主机号**都要掐头去尾：
    - **主机号 全0** 的地址是**网络地址**，不能分配给主机和路由器各接口；
    - **主机号 全1** 的地址是**广播地址**，不能分配给主机和路由器各接口；
- 根据地址的构造可以看出：
    - **A 类地址网络少，但主机多**
    - **B 类地址一半一半**
    - **C 类地址网络多，但主机少**

**（1）A类地址**

![ipv4-03.png](/images/net/ipv4-03.png "IPv4 -A")

一共 32 位，8位网络号【首部固定为 0】，24位主机号：
- 网络号
    - 最小（全0）：保留
    - 最大（全1）：本地环回测试，保留
- 主机号固定留着最小和最大
    - 最小（全0）：网络地址
    - 最大（全1）：广播地址

**（2）B类地址**

一共32位，16 位网络号【首部固定为 10】，16 位主机号：
![ipv4-04.png](/images/net/ipv4-04.png "IPv4 - B")

**（3）C类地址**
一共32位，24 位网络号【首部固定为 110】，8 位主机号：
![ipv4-05.png](/images/net/ipv4-05.png "IPv4 - C")

（4）根据 **X.Y.Z.W** 判断是哪类地址：

1. 判断网络类型
- **X < 127：A**
- **128 - 191：B**
- **192 - 223：C**
2. 得到网络号
- A类的网络号为X
- B类的网络号为XY
- C类的网络号为XYZ
3. 剩下的就是主机号了
4. 不能指派的地址：
- A 的**网络号**0和127
- **主机号**全0或全1

5. 特殊的地址：
- 0.0.0.0 ：表示 "在本网络上的本主机" ，只能作为源地址；
- 255.255.255.255：表示 "只在本网络上进行广播（路由器不转发）"，只能作为目的地址；

![ipv4-06.png](/images/net/ipv4-06.png "IPv4")

----------
### 3.3 **子网掩码**：划分子网的 IPv4 地址

（一）为何会有划分子网这样的需求？

如图，一个大型局域网需要连到因特网，如果申请 C 类地址，主机数量只有254个，不够用。因此申请了 B 类地址，主机数 65534 个，但是会剩下大量的 IP 地址，只能由该单位的同一个网络使用，其他单位不能用。

![subnet01.png](/images/net/subnet01.png "subnet01")

现在，型局域网新增了不少计算机，并且还需要将原来的网络划分成三个独立的网络：子网1 2 3 。如果子网1仍然沿用之前的 B 类地址，那么需要为 2 3 各自申请网络地址，但这：
- 需要等待时间和花费费用
- 其他路由表还要新增记录
- 浪费ip地址

![subnet02.png](/images/net/subnet02.png "subnet02")

如果可以从 IP 地址的**主机号部分 借来**一些位作为子网号来区分不同的子网，就可以利用原有网络中的大量剩余 ip，而不用申请新的网络地址；

![subnet03.png](/images/net/subnet03.png "subnet03")

那么如何划分子网，如何规范地借用主机号部分？

（二）**子网掩码**

**子网掩码长 32 比特，它可以表明分类 IP 地址的主机号部分被借用了几个比特作为子网号**。
如何表明：
- 子网掩码使用**连续的 比特1 来对应网络号和子网号**；
- 子网掩码使用**连续的 比特0 来对应主机号**；
- 将划分子网的 IPv4 地址与其相对应的子网掩码进行**逻辑与**运算就可得到 IPv4 地址所在子网的网络地址；

![subnet04.png](/images/net/subnet04.png "子网掩码")

子网掩码与主机对应的 主机号部分表示从主机号借用多少比特来作为子网号。

下面举例说明如何划分：

![subnet05.png](/images/net/subnet05.png "子网掩码")

划分子网前，原局域网络的 IPv4 地址结构是这样的：

![subnet06.png](/images/net/subnet06.png "原C类地址")

然后，我们从主机号中借用几位作为子网号，本质上是把主机号划分成几个部分：如图：
- 本题的网络地址是 C 类地址，即**主机号8位**；
- 子网掩码的主机部分是128，也就是**借用主机号 1 个 bit 位（最高那位）**，下面我们看是怎么均分为两个子网的：
- ![subnet07.png](/images/net/subnet07.png "均分为两个子网")

如果借用更多位，也可以划分成更多子网，这取决于子网掩码。这样就很清楚的看到：**子网掩码只借用主机号，并不改变网络号**，所以分出来的地址组仍然同属一个网络，也对应了子网的叫法。

一个关于子网掩码的练习：
![subnet08.png](/images/net/subnet08.png "子网")

最后，默认的子网掩码是指在未划分子网的情况下使用的子网掩码（这取决于主机号长度，也就是地址类型A/B/C）
![subnet09.png](/images/net/subnet09.png "默认子网掩码")

---------
### 3.4 无分类编址的 IPv4 地址

**- 3.4.1 CIDR**

【来源/作用】：划分子网在一定程度上缓解了因特网发展中遇到的困难，但是**数量巨大的 C 类网因为地址空间太小没有得到充分使用**，而 IP 地址加速消耗，**IPv4 地址面临耗尽**的威胁。出现了无分类编址方法解决 IPv4 地址紧张的问题，同时成立 IPv6 。

无分类域间路由选择 CIDR （Classless Inter-Domain Routing）消除了传统 A B C 类地址，以及划分子网的概念。 CIDR 可以更有效地分配 IPv4 的地址空间，并在 IPv6 使用之前允许互联网规模继续增长。

CIDR 使用“**斜线记法**”，或 CIDR 记法，即在 IPv4 地址后面加上斜线“/”，**斜线后面写上网络前缀所占的比特数量**。【X. Y. Z. W / V】的形式，如图：一共32位，前缀占20：【前20个bit表示网络，后12个bit表示主机】

![cidr01.png](/images/net/cidr01.png "CIDR")

CIDR 实际上是**将网络前缀都相同的连续 IP 地址组成一个“CIDR 地址块”**，只要知道块中任一地址，就能知道该地址块的全部细节：
- 地址块的最小地址
- 地址块的最大地址
- 地址块中的地址数量
- 地址块聚合某类(A/B/C)网络的数量
- 地址掩码（子网掩码）

例如：
![cidr02.png](/images/net/cidr02.png "CIDR02")

#### - 3.4.2 路由聚合（构造超网）

情景如下：R1 与五个网络和 R2 直连，R1 R2 周期性通告对方自己的路由信息。
- ![cidr03.png](/images/net/cidr03.png "场景")
- 如果 R1 将自己所知的五个网络都通告 R2 ，则 R2 路由表会增加**五条**路由记录；
    - 问题来了：为了减少路由记录对路由表的占用，可以尝试**将这五条记录聚合**成一条吗？
    - ![cidr04.png](/images/net/cidr04.png "场景") 

路由聚合的方法是：找**共同前缀**：即这五个目的网络地址的共同前缀
- 五个网络地址前两个字节相同，就第三个字节不同，把第三个字节转成二进制形式，查到共同前缀是 前 22 个比特，即为【/22】
- 共同前缀保持不变，剩余 10个bit 全部取0 ，写成 IPv4 的点分十进制格式，放在【/22】的前面，得到的称为 **聚合后的地址块（超网）**；
    - ![cidr05.png](/images/net/cidr05.png "超网")

- 可以看到，**网络前缀越长，地址块越小，路由越具体**
- 如果路由器查表转发分组时发现有多条路由可选，则选网络前缀最长的那条，称为**最长前缀匹配**（因为这样的路由更具体）

---------------

### 3.5 IPv4 的应用：定长和变长子网掩码

给一个 IPv4 地址块，如何将其划分成几个更小的地址块，并将这些地址块分配给不同网络，最后可以分给主机和路由器接口。一般有以下两种方法：
- **定长**的子网掩码（FIxed Length Subnet Mask）：用**同一个**子网掩码划分子网；
    - 子网掩码定长，每个子网分配到相同数量的 IP 地址，可能浪费；
- **变长**的子网掩码（Variable Length Subnet Mask）：用**不同的**子网掩码划分子网；
    - 各子网分配到的 IP 地址数可以不同，尽可能**减少浪费**；

**3.5.1 定长子网掩码FLSM 划分方法**

有如下场景：
![mask01.png](/images/net/mask01.png "子网掩码")

要划分出五个子网，那么就得 4 < 5 < 8 ， 借用三个主机号位（8个子网）。而是C类地址，剩余5位，2^5=32，每个子网还剩 32 个主机号可供分配，满足要求。得到的子网掩码如下：

![mask02.png](/images/net/mask02.png "子网掩码")

子网的详细细节如下：

![mask03.png](/images/net/mask03.png "子网详细信息")

从这八个子网中任选五个网分配给N1-N5，子网中任选主机号分配给里面的主机即可。不过这样显然会造成 IP 地址的浪费，例如图中的网络5只需要 4 个 IP 地址，但这种划分子网的方式分给了它 32 个，造成 IP 地址的浪费。为了避免浪费，可以采用变长子网掩码划分子网：

**3.5.2 变长子网掩码VLSM 划分方法**

依然考虑上面的例子：
- 子网 N1 需要9个主机号， 9 < 16，只能给它16个，这要借用**四个**主机号位，剩下 32-4 = 28个网络前缀；
- 子网 N2 需要28个主机号， 28 < 32，只能给它32个，这要借用**五个**主机号位，剩下32-5 = 27个网络前缀；
- 子网 N5 需要4个主机号，给它4个，这要借用**两个**主机号位，剩下32-2 = 30个网络前缀；

![mask04.png](/images/net/mask04.png "变长")

现在的应用需求变为：从地址块 218.75.230.0/24 （**C类网络的第三种表示方法**）中取出 5 个地址块（1个 /27 地址块，3个 /28 地址块，1个 /30 地址块），按需分配给下图所示的 5 个网络。

![mask05.png](/images/net/mask05.png "分配方法")

分配的结果如下图：

![mask06.png](/images/net/mask06.png "变长分配结果")

结合网络，如下图，N2 的地址块为 218.75.230.0/27，即前27位都是表示网络的，剩下5位表示主机，所以32个主机地址。接下来 N1的地址块为【218.75.230.32/28】，只有后四位可以动，如图，N3也同理，只有后四位可以动，N1和N3 都是只有后四位可以动的，区别它们的就是网络号了。如图细节，尽管都是 /28 ，但并不会产生冲突（因为8位网络号不同，属于不同子网）。

![mask07.png](/images/net/mask07.png "变长分配细节")

显然变长子网掩码每个子网分配到的 IP 地址数量可以不相同（有32个的子网，也有16个，4个的子网），减少浪费。最后的分配结果如下：
![mask08.png](/images/net/mask08.png "最终结果")

-------

## 4. IP 数据报的发送和转发过程

IP 数据报的发送和转发过程包含：
- **主机发送**数据报；
- **路由器转发** IP 数据报；

> 本节重点关注 **网际层发送和转发 IP 数据报的过程**，忽略 ARP 协议获取 MAC（因为设计 MAC 是链路层的内容，网际层享受服务即可），以及以太网交换机自学习和转发帧的过程（同理）。

场景如下图，网络地址和子网掩码已经配置好了：

![ip01.png](/images/net/ip01.png "场景")

【问题1】**源主机如何知道目的主机与自己是否处于同一个网络中？**因为不同网络需要用到路由器，同一个网络交换机就能搞定了，属于数据链路层的活。

![ip02.png](/images/net/ip02.png "场景")

- 如图，C给F发IP数据报
    - C把自己的IP地址与子网掩码相与，得到自己的网络地址；
    - 由于是C给F发，C肯定知道F的IP地址，与C的子网掩码相与，得到目的网络地址；
    - 自己的网络地址和目的网络地址不同，就知道了C与F不在同一网络，属于**间接交付**；
    - ![ip03.png](/images/net/ip03.png "场景")
- 那么 C 需要先发给路由器，由路由器将 IP 数据报转发给主机 F。

【问题2】对于间接交付，C 如何知道应该把 IP 数据报交给哪个路由器进行转发呢？

- 为了让本网络中的主机能和其他网络中的主机通信，必须为其指定本网络中的一个路由器，帮忙转发，所指定的路由器也称为 **默认网关** 。
- 对于本例，可以把 R 的接口0的IP地址指定给网络中各主机，并作为默认网关，如下图：
    - ![ip04.png](/images/net/ip04.png "默认网关")
    - 这样，当本网络中的主机要和**其他网络**中的主机进行通信时，会**将 IP 数据报传输给默认网关**，帮忙转发；

【问题3】路由器收到 IP 数据报后又是如何转发的？

![ip05.png](/images/net/ip05.png "路由器的任务")

检查IP数据报**差错**，获得 IP 数据报的**源地址和目的地址**，查**路由表**【如下】得到目的网络地址，按表中下一跳指示转发；

![ip06.png](/images/net/ip06.png "路由表")

- 当给路由器接口配置 IP 地址和子网掩码时，路由器就知道了 哪个接口与哪个网络直连。**如果接口和该网络直连，则不需要下一跳**；
- 还可以手工配置静态路由；
- 还有路由器使用路由协议自动获取到的动态路由；

路由表还需要设计很好的数据结构，以便提高查找速度；全过程如下所示：

![ip07.png](/images/net/ip07.png "路由过程")

【问题4】路由器隔离广播域

- A 给本网络发送广播IP数据报，路由器端口收到广播不转发，做到隔离广播域。
    - ![ip09-1.png](/images/net/ip09-1.png "路由器隔离1")

- A 给另一个网络发送广播IP数据报，路由器端口收到广播仍然不转发。
    - ![ip09-2.png](/images/net/ip09-2.png "路由器隔离2")

关于 IP 数据报的练习：

![ip08.png](/images/net/ip08.png "练习")

----------------

## 5. 静态路由（人工）配置及其路由问题

- **静态路由配置**：用户或网络管理员使用路由器的相关命令给路由器**人工配置路由表**。
    - 简单，开销小，但**不能及时适应网络状态（流量，拓扑）的变化**；
    - 一般只在小规模网络中使用；

- 静态路由配置可能出现以下**导致产生路由环路**的错误：
    - 配置错误；
    - 聚合了不存在的网络；
    - 网络故障；

举例场景如下：
![src01.png](/images/net/src01.png "静态路由配置场景")

- 接口 0 的配置可以根据自身的 IP 地址和子网掩码自动得出接口所在的网络地址，而且由于接口与网络**直连**，下一跳可以直接跳到网络中的某主机。
    - ![src02.png](/images/net/src02.png "路由配置场景")

假设 R1 要转发ip数据报到蓝色网络的主机，但 R1 的路由表里没有蓝色网络的网络地址条目，也就是 R1 并不知道蓝色网络的存在。因此可以使用路由器的相关配置命令**人工配置静态路由**，给 R1 加一条到达蓝色网络的路由条目。
- 条目中，R1 到达蓝色网络的下一跳应该是 R2 的接口0 ，所以填入R2 的接口 0 的 IP。
    - ![src03.png](/images/net/src03.png "人工配置场景")
- 同理也给 R2 添加一个能到黄色网络的条目，按图应该填入 R1 的接口 1。
    - ![src03-1.png](/images/net/src03-1.png "人工配置场景2")

### 默认路由

新的场景如下：现在 R2 连上了互联网，里面有很多网络，如果 R1 要发给互联网中某网络X中的主机Y（下一跳肯定是 接口 0 了），那么查R1的路由表里有没有X的条目。但是互联网里有很多XYZ ... 人工配置工作量巨大，路由表也会非常大，查表转发的速度也降低了。

![src04.png](/images/net/src04.png "场景")

实际上，**对于具有相同下一跳的不同目的网络的路由条目，可以用一条默认路由条目来替代**。

默认路由条目：
- 目的网络地址为 **0.0.0.0/0**（掩码0，SIDR：/0）；
- （本例而言）下一跳为 R2 的接口0 的ip ；
- 默认路由也是人工配置，类型也是静态；

路由表如下：
![src05.png](/images/net/src05.png "路由表")



