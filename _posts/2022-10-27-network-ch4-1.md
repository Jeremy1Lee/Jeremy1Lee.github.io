---
layout: post
title: "计网 Ch4：网络层-1"
author: LJC
tags:
- network
date: 2022-10-27 20:50 +0800
toc: true
---

# 网络层 (Data link layer)

## 1. 网络层概述

网络层的主要任务是**实现网络互连**，进而实现数据包在各网络之间的传输，如图，如果这些**异构型网络**（有线，无线，总线，共享，广域，局域 ......）实现内部通信，只需要实现物理层和数据链路层即可，但如果将异构型网络互连起来，形成一个更大的互联网，就需要使用网络层互连设备**路由器**。连接后这些网络可以只看成链路。

![web01.png](/images/net/web01.png "网络层")

要实现数据包传不同网络，就必须实现**网络层**，它需要解决以下**主要问题**：
- **网络层向运输层提供怎样的服务**（ **可靠传输 还是 不可靠传输** ）
    - 误码，被丢弃，乱序等传输错误，不采取措施为不可靠传输；
    - 不同网络体系结构提供服务可能不同
        - 因特网（TCP/IP）的网际层提供不可靠，无连接的数据报服务；
        - ATM，帧中继等的网络层提供面向连接的可靠虚电路服务；
- **网络层寻址问题**
    - TCP/IP 的网际层使用 IP 地址，不同网络的地址表达不同，如图：
    - ![web02.png](/images/net/web02.png "网络层")
- **路由选择问题**
    - 数据包从源站到目的站的路径选择
    - 如图，路由器把数据包转发到哪个接口？——路由表，如何得到；
    - ![web03.png](/images/net/web03.png "路由选择")

**因特网**（Internet）是目前全世界用户数量最多的互联网，它使用 TCP/IP 协议栈。TCP/IP 的网络层使用网际协议 IP 作为核心，因此在 TCP/IP 协议栈中网络层常称为**网际层**。

接下来将基于 **TCP/IP 协议的网际层**来学习网络层的理论知识和实践技术，网际层除了核心 IP 协议，还有地址解析协议 ARP ，ICMP 协议， IGMP 协议等；
![web04.png](/images/net/web04.png "TCP/IP 协议")

------------
## 2. 网络层提供的两种服务（面向连接 和 无连接）

### 2.1 面向**连接**的虚电路服务

虚电路服务的<mark>核心思想</mark>是：可靠通信**由网络自身**来保证；

- 两台计算机通信时，首先建立**网络层的连接** —— **虚电路 VC** (Virtual Circuit)，保证通信双方所需的一切网络资源；
- 通信**双方沿着已建立的虚电路发送分组**；
    - ![web05.png](/images/net/web05.png "虚电路 VC")
    - 虚电路表示这是一条逻辑上的连接，分组沿这条路径按 存储转发方式 发送，而不是真正的物理连接，所以是**虚**电路
- 完整的目的主机地址 仅在只在建立连接阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**（构成虚电路的每一段 <u>链路</u> 都有一个虚电路编号）
- 这种通信方式如果再使用上可靠传输的网络协议，就可使发送的分组最终**正确到达**接收方（无差错按序到达，不丢失不重复）；
- **通信结束后，需要释放之前所建立的虚电路**；

> 很多广域分组交换网都使用面向连接的虚电路服务，如曾经的X.25和ARM，FR等，不过**因特网并没有采用这种虚电路服务，而是数据报服务**

### 2.2 无连接的**数据报**服务

数据报服务的<mark>核心思想</mark>是：**可靠通信应当由用户主机来保证**，简单灵活，尽最大努力交付的数据报服务。

- 两台计算机通信时，**不需要建立网络层连接**
- 每个**分组可以走不同的路径**，因此**分组的首部必须携带目的主机的完整地址**
    - 所以这种方式所传送的分组可能误码，丢失，重复和失序等
    - ![web06.png](/images/net/web06.png "数据报服务")
- 由于**网络本身不提供端到端的可靠传输服务**，使网络中的路由器可以做的比较简单，成本低（相对交换机而言）
- 因特网采用此思想，**将复杂的网络处理功能置于因特网边缘（即用户主机和其内部的运输层）**，而将相对简单的尽最大努力的分组交付功能置于因特网核心，网络造价降低，简单灵活，应用多。

总结一下两种服务：
![web07.png](/images/net/web07.png "服务")

因特网的网际层提供尽最大努力交付的数据报服务，也是本章围绕的主题：网际层如何传送 IP 数据报（分配地址，路由机制，IP 协议等）

------------
## 3. **IPv4 地址**

### 3.1 IPv4 概述

【概念】：**IPv4 地址是给因特网上每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的 32 比特的标识符。**

【作用/为什么要有ipv4】：异构网络的设备想互连，总要有地址来寻找各设备，两部分：网络，主机

**1.如何分配：**
IP 地址由 ICANN 机构统一分配，15年开始逐步用 IPv6 。IPv4 的编制方法经历了以下三个历史阶段：
![web08.png](/images/net/web08.png "IPv4 的编制方法")

**IPv4 的表示：**
32位的 IPv4 地址不方便阅读，记录，输入等，因此 IPv4 地址采用 **点分十进制表示方法** 以方便用户使用；

![ipv4-01.png](/images/net/ipv4-01.png "IPv4 的表示方法")

-------------
### 3.2  IPv4 的**分类编址**：ABCDE 五类

分类编址分五类：

![ipv4-02.png](/images/net/ipv4-02.png "IPv4 五类")

- 只有 ABC 类可分配给网络中的主机或路由器各接口；
- 对不同类网络，**网络号**有保留的也有不留的；
- 对所有五类网络而言，**主机号**都要掐头去尾：
    - **主机号 全0** 的地址是**网络地址**，不能分配给主机和路由器各接口；
    - **主机号 全1** 的地址是**广播地址**，不能分配给主机和路由器各接口；
- 根据地址的构造可以看出：
    - **A 类地址网络少，但主机多**
    - **B 类地址一半一半**
    - **C 类地址网络多，但主机少**

**（1）A类地址**

![ipv4-03.png](/images/net/ipv4-03.png "IPv4 -A")

一共 32 位，8位网络号【首部固定为 0】，24位主机号：
- 网络号
    - 最小（全0）：保留
    - 最大（全1）：本地环回测试，保留
- 主机号固定留着最小和最大
    - 最小（全0）：网络地址
    - 最大（全1）：广播地址

**（2）B类地址**

一共32位，16 位网络号【首部固定为 10】，16 位主机号：
![ipv4-04.png](/images/net/ipv4-04.png "IPv4 - B")

**（3）C类地址**
一共32位，24 位网络号【首部固定为 110】，8 位主机号：
![ipv4-05.png](/images/net/ipv4-05.png "IPv4 - C")

（4）根据 **X.Y.Z.W** 判断是哪类地址：

1. 判断网络类型
- **X < 127：A**
- **128 - 191：B**
- **192 - 223：C**
2. 得到网络号
- A类的网络号为X
- B类的网络号为XY
- C类的网络号为XYZ
3. 剩下的就是主机号了
4. 不能指派的地址：
- A 的**网络号**0和127
- **主机号**全0或全1

5. 特殊的地址：
- 0.0.0.0 ：表示 "在本网络上的本主机" ，只能作为源地址；
- 255.255.255.255：表示 "只在本网络上进行广播（路由器不转发）"，只能作为目的地址；

![ipv4-06.png](/images/net/ipv4-06.png "IPv4")

----------
### 3.3 **子网掩码**：划分子网的 IPv4 地址

（一）为何会有划分子网这样的需求？

如图，一个大型局域网需要连到因特网，如果申请 C 类地址，主机数量只有254个，不够用。因此申请了 B 类地址，主机数 65534 个，但是会剩下大量的 IP 地址，只能由该单位的同一个网络使用，其他单位不能用。

![subnet01.png](/images/net/subnet01.png "subnet01")

现在，型局域网新增了不少计算机，并且还需要将原来的网络划分成三个独立的网络：子网1 2 3 。如果子网1仍然沿用之前的 B 类地址，那么需要为 2 3 各自申请网络地址，但这：
- 需要等待时间和花费费用
- 其他路由表还要新增记录
- 浪费ip地址

![subnet02.png](/images/net/subnet02.png "subnet02")

如果可以从 IP 地址的**主机号部分 借来**一些位作为子网号来区分不同的子网，就可以利用原有网络中的大量剩余 ip，而不用申请新的网络地址；

![subnet03.png](/images/net/subnet03.png "subnet03")

那么如何划分子网，如何规范地借用主机号部分？

（二）**子网掩码**

**子网掩码长 32 比特，它可以表明分类 IP 地址的主机号部分被借用了几个比特作为子网号**。
如何表明：
- 子网掩码使用**连续的 比特1 来对应网络号和子网号**；
- 子网掩码使用**连续的 比特0 来对应主机号**；
- 将划分子网的 IPv4 地址与其相对应的子网掩码进行**逻辑与**运算就可得到 IPv4 地址所在子网的网络地址；

![subnet04.png](/images/net/subnet04.png "子网掩码")

子网掩码与主机对应的 主机号部分表示从主机号借用多少比特来作为子网号。

下面举例说明如何划分：

![subnet05.png](/images/net/subnet05.png "子网掩码")

划分子网前，原局域网络的 IPv4 地址结构是这样的：

![subnet06.png](/images/net/subnet06.png "原C类地址")

然后，我们从主机号中借用几位作为子网号，本质上是把主机号划分成几个部分：如图：
- 本题的网络地址是 C 类地址，即**主机号8位**；
- 子网掩码的主机部分是128，也就是**借用主机号 1 个 bit 位（最高那位）**，下面我们看是怎么均分为两个子网的：
- ![subnet07.png](/images/net/subnet07.png "均分为两个子网")

如果借用更多位，也可以划分成更多子网，这取决于子网掩码；

一个关于子网掩码的练习：
![subnet08.png](/images/net/subnet08.png "子网")

最后，默认的子网掩码是指在未划分子网的情况下使用的子网掩码（这取决于主机号长度，也就是地址类型A/B/C）
![subnet09.png](/images/net/subnet09.png "默认子网掩码")

---------
### 3.4 无分类编址的 IPv4 地址

**- 3.4.1 CIDR**

【来源/作用】：划分子网在一定程度上缓解了因特网发展中遇到的困难，但是**数量巨大的 C 类网因为地址空间太小没有得到充分使用**，而 IP 地址加速消耗，**IPv4 地址面临耗尽**的威胁。出现了无分类编址方法解决 IPv4 地址紧张的问题，同时成立 IPv6 。

无分类域间路由选择 CIDR （Classless Inter-Domain Routing）消除了传统 A B C 类地址，以及划分子网的概念。 CIDR 可以更有效地分配 IPv4 的地址空间，并在 IPv6 使用之前允许互联网规模继续增长。

CIDR 使用“**斜线记法**”，或 CIDR 记法，即在 IPv4 地址后面加上斜线“/”，**斜线后面写上网络前缀所占的比特数量**。【X. Y. Z. W / V】的形式，如图：一共32位，前缀占20：【前20个bit表示网络，后12个bit表示主机】

![cidr01.png](/images/net/cidr01.png "CIDR")

CIDR 实际上是**将网络前缀都相同的连续 IP 地址组成一个“CIDR 地址块”**，只要知道块中任一地址，就能知道该地址块的全部细节：
- 地址块的最小地址
- 地址块的最大地址
- 地址块中的地址数量
- 地址块聚合某类(A/B/C)网络的数量
- 地址掩码（子网掩码）

例如：
![cidr02.png](/images/net/cidr02.png "CIDR02")

#### - 3.4.2 路由聚合（构造超网）

情景如下：R1 与五个网络和 R2 直连，R1 R2 周期性通告对方自己的路由信息。
- ![cidr03.png](/images/net/cidr03.png "场景")
- 如果 R1 将自己所知的五个网络都通告 R2 ，则 R2 路由表会增加**五条**路由记录；
    - 问题来了：为了减少路由记录对路由表的占用，可以尝试**将这五条记录聚合**成一条吗？
    - ![cidr04.png](/images/net/cidr04.png "场景") 

路由聚合的方法是：找**共同前缀**：即这五个目的网络地址的共同前缀
- 五个网络地址前两个字节相同，就第三个字节不同，把第三个字节转成二进制形式，查到共同前缀是 前 22 个比特，即为【/22】
- 共同前缀保持不变，剩余 10个bit 全部取0 ，写成 IPv4 的点分十进制格式，放在【/22】的前面，得到的称为 **聚合后的地址块（超网）**；
    - ![cidr05.png](/images/net/cidr05.png "超网")

- 可以看到，**网络前缀越长，地址块越小，路由越具体**
- 如果路由器查表转发分组时发现有多条路由可选，则选网络前缀最长的那条，称为**最长前缀匹配**（因为这样的路由更具体）
---------------
### 3.5 IPv4 地址的应用规划

给一个 IPv4 地址块，如何将其划分成几个更小的地址块，并将这些地址块分配给不同网络，最后可以分给主机和路由器接口。






