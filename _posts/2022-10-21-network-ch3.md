---
layout: post
title: "计算机网络（三）：数据链路层"
author: LJC
tags:
- network
date: 2022-10-21 15:10 +0800
toc: true
---

# 三、数据链路层 (Data link layer)

## 1. 数据链路层概述

数据链路层在网络体系结构中的地位，看图：有多种网络

- 主机：有五层，数据逐层封装，物理层转换成电信号发送；目的主机逐层解封出数据；
- 路由器：只有三层，解封到网络层，根据目的网络地址查表确定转发端口，封装并发送；
- 物理层下的传输媒体互连设备

![dlink01.png](/images/net/dlink01.png "物理层"){: .align-center}

而研究数据链路层时，可以不看这些过程，只看成数据在相连的链路上传输。

### 基本概念

- **链路 Link** ：从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点；

- **数据链路 Data Link** ：把实现通信协议的硬件和软件加到链路上，就构成了数据链路；

- **帧 Frame** ：在数据链路层上传输的数据包，是数据链路层的数据单位；

### 数据链路层中三个重要问题：
1. **封装成帧**：数据链路层给网络层交付的协议数据单元**添加帧头和帧尾**的操作。目的在于在链路上以帧为单元传输数据，如下图例子：

![dlink02.png](/images/net/dlink02.png "帧头和帧尾"){: .align-center}

2. **差错检测**：发送方将封装好的帧通过物理层发送到传输媒体，帧在传输中遭遇干扰可能会出现**误码**（比特0可能变成比特1）。那么，接收方如何检测到误码？
- 发送方在发送帧之前，基于<u>待发送的数据和检错算法</u>计算出**检错码**，并封装在帧尾。例如上图 FCS 字段就是检错码。
- 接收方收到帧后，通过检错码和算法可以判断出是否出现了误码。
- 接收方**丢弃**有误码的帧，此时：
    - 如果这次 数据链路层向上层提供的是**不可靠服务，直接丢弃**；
    - 如果是可靠服务，还有其他措施确保接收方可以重新收到正确的副本。

3. **可靠传输**：误码不能完全避免，但若能实现发送方发送什么，接收方就能收到什么，就是可靠传输。

### 使用广播信道的数据链路层

回答第一章的两个问题：

![dlink03.png](/images/net/dlink03.png "总线型网络"){: .align-center}

> 1. 在总线型网络，主机如何知道哪个帧才是发给自己的？

帧的目的地址加入帧一起传输，如上图2的帧格式，帧头的三个字段有目的地址和源地址，

> 2. 多台主机同时传输，信号发生碰撞怎么办？（广播信道不可避免的）

**以太网采用媒体接入控制协议 CSMA/CD 检测碰撞**。

-----------------------

## 2. 封装成帧

数据链路层给上层交付的协议数据单元PDU**添加帧头和帧尾**使其成为帧，因此：

1. 帧头和帧尾中有重要的控制信息（并不只有封装相关，还有差错控制相关）

![dlink04.png](/images/net/dlink04.png "帧"){: .align-center}

> 发送方的数据链路层把上层交付的PDU封装成帧后，交给物理层将构成帧的各比特转换成电信号发到传输媒体。**接收方的数据链路层是如何从物理层交付的比特流中提取出帧的？**

2. 帧头和帧尾的作用之一是 **帧定界**；

3. 透明传输：**指数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在一样。也就是说，数据链路层会想办法让插入的帧头和帧尾和数据内容没有重复冲突，实现方法比如：
    - 面向**字节 char/int**的物理链路使用字节填充（字符填充）实现透明传输；
        - 发送帧之前扫描数据，在 数据里的帧定界符 前面插入一个 **转义字符** ；
        - 上层PDU里既包含帧定界符，又包含转义字符：仍然扫描，在重复的 <u>帧定界符</u> 和 <u>转义字符</u> 前面都插入 **转义字符**；
        - 两遍扫描，就能解决这个问题。目的主机拆封时扫描比特流，发现转义字符先剔除，并继续读取数据，直到没有转义字符并读取到帧尾flag结束；![dlink05.png](/images/net/dlink05.png "面向字节"){: .align-center}
    - 面向**比特 0/1**的物理链路使用**比特填充**实现透明传输：
        - 下图 01111110 是帧定界标志；
        - 如果数据里有连续五个 1 ，就插入一个 0 ，避免冲突；
        - 提取帧时，每连续五个 1 后面的 0 剔除即可；

![dlink07.png](/images/net/dlink07.png "面向比特"){: .align-center}

4. 为提高效率，应使帧的数据部分长度尽可能大。
5. 每种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元 MTU**

---------------------------

## 3. 差错检测

实际通信链路不是理想的，可能产生差错：1可能变成0，0可能变成1，称为**比特差错，或误码**。传输错误的比特占传输总数的比率为误码率 **BER(Bit Error Rate)**。

使用**差错检测码**来检测数据在传输中是否产生了比特差错，是数据链路层的重要任务之一。

### 3.1 奇偶校验
在待发送的数据后面添加 **1 位奇偶校验位**，可1可0，使整个数据（包括所添加的校验位在内）<mark>在添加后</mark>：
- 1 的个数为奇数：**奇校验**
- 1 的个数为偶数：**偶校验**

![dlink06.png](/images/net/dlink06.png "奇偶校验"){: .align-center}

显然奇偶校验比较粗，漏检率较高，链路层一般不用它。下面的CRC检错能力很强，漏检率极低：

### **3.2 循环冗余校验 CRC (Cyclic Redundancy Check)**
- 收发双方约定好一个**生成多项式** G(x) ，要求生成多项式**必须包含最低次项(常数项)**
- 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输的数据后面一起传输；
- 收方通过生成多项式 G(x) 计算收到的数据是否有误码； 

1. **CRC 算法**流程如图所示：

![dlink08.png](/images/net/dlink08.png "CRC"){: .align-center}

2. CRC 算法的**发送**过程举例：

![dlink09.png](/images/net/dlink09.png "CRC算法过程1"){: .align-center}

- 其中的“除法” <u>比的是位数，不是大小：位数=除数位数则上1，不够上0</u> ； 
- 拉下来和除数作**异或**(相同为0)运算，并继续，得到**余数**；
- 余数的位数要与 生成多项式的最高次数 相同，**在余数前补 0 凑足位数**，才是冗余码；
- 最后把冗余码添加到待发送数据的**后面**；

3. CRC 算法的**接收**过程举例：

![dlink10.png](/images/net/dlink10.png "CRC算法过程2"){: .align-center}

### 3.3 注意

- **检错码**只能检测出帧在传输过程中出现了差错，不能定位错误，因此**无法纠正错误**；
- 冗余信息更多的纠错码可以进行前向纠错，但开销较大，计网中很少使用；
- **CRC** 漏检率非常低，计算稍复杂，但**容易硬件实现，广泛应用于数据链路层**；
- 计网中通常采用检错重传方式来纠正差错（可靠），或者丢弃帧（不可靠）；

---------------------------

## 4. 可靠传输及三种实现方法

> 收方的数据链路层通过帧尾中的检错码，如 FSC 字段检测到帧中出现了比特差错，接下来该如何处理呢？

可以肯定的是，这首先取决于数据链路层向上层提供的服务类型：
- 如果提供的是不可靠传输服务：丢弃有误码的帧就完事了；
- 可靠传输服务：想办法实现：发送方发送什么，接收方就收到什么；

> 我们会想，直接让收方发一个“之前的帧有误码，请重发”的消息不就行了？实际上肯定不会如此简单，如果又出现误码了怎么办？

一般情况下：
- **有线**链路的误码率比较低，为了减小开销，并不要求数据链路层向上提供可靠传输服务。即使出现了误码，可靠传输的问题抛给其上层处理。
- **无线**链路**易受干扰**，误码率较高，因此要求数据链路层**必须向上层提供可靠传输服务**。

### 4.1 可靠传输的基本概念

1. 比特差错只是传输差错中的一种，传输差错还包括**分组丢失，分组失序，和分组重复**。

2. 传输差错不仅局限于数据链路层的比特差错，所以上面说的是“分组”。如图：

![dlink11.png](/images/net/dlink11.png "差错场景"){: .align-center}

- 分组丢失：H6给H2发送分组到达**路由器**R5，但R5的输入队列满了，R5根据自己的分组丢弃策略将该分组**丢弃**；

- 分组失序：H6给H2发了3个分组，但由于路线不同，它们**没有按照原顺序**到达H2；

- 分组重复：H6给H2发送的分组由于某些原因（如路线远）在网络中**滞留**了，没有及时到达H2，可能造成H6对该分组的**超时重发**，一段时间后这几个分组都到达了H2；

3. 不过，分组丢失，分组失序，和分组重复这些差错一般不会出现在数据链路层，而会出现在其上层。
4. 因此，**可靠传输服务并不仅局限于数据链路层**，其他各层均可选择实现可靠传输。比如，IP协议就是向其上层提供无连接不可靠传输服务等。
5. 最后，可靠传输实现较复杂，开销也较大，是否使用取决于应用需求。

























